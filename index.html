<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwineCare - IoT Swine Monitoring System</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-messaging-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-pink: #E91E63;
            --secondary-pink: #F06292;
            --light-pink: #FCE4EC;
            --accent-pink: #FF4081;
            --dark-pink: #C2185B;
            --success-green: #4CAF50;
            --warning-orange: #FF9800;
            --error-red: #F44336;
            --neutral-gray: #9E9E9E;
            --light-gray: #F8F9FA;
            --dark-gray: #424242;
            --white: #FFFFFF;
            --shadow: rgba(233, 30, 99, 0.08);
            --shadow-lg: rgba(233, 30, 99, 0.15);
            --border-color: #E8E8E8;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            line-height: 1.6;
            color: var(--dark-gray);
            background: var(--light-gray);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Auth Pages */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: url('https://wxyzofficial.sirv.com/Personal/bg.png') center/cover;
            position: relative;
        }

        .auth-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(233, 30, 99, 0.3);
            backdrop-filter: blur(8px);
        }

        .auth-container::after {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(240, 98, 146, 0.2), transparent);
            border-radius: 50%;
            bottom: -100px;
            left: -100px;
            animation: float 8s ease-in-out infinite reverse;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) translateX(0px); }
            50% { transform: translateY(-20px) translateX(10px); }
        }

        .auth-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 460px;
            position: relative;
            z-index: 1;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .auth-header {
            text-align: center;
            margin-bottom: 2.5rem;
        }

        .auth-logo {
            width: 85px;
            height: 85px;
            background: linear-gradient(135deg, var(--primary-pink), var(--accent-pink));
            border-radius: 20px;
            margin: 0 auto 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.2rem;
            box-shadow: 0 10px 30px rgba(233, 30, 99, 0.3);
        }

        .auth-header h1 {
            font-size: 1.9rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .auth-header p {
            color: var(--neutral-gray);
            font-size: 0.95rem;
            font-weight: 500;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.6rem;
            font-weight: 600;
            color: var(--dark-gray);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.95rem 1.2rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: var(--white);
            font-family: 'Inter', sans-serif;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-pink);
            background: rgba(233, 30, 99, 0.02);
            box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.08);
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-pink), var(--accent-pink));
            color: white;
            width: 100%;
            box-shadow: 0 8px 20px rgba(233, 30, 99, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 28px rgba(233, 30, 99, 0.4);
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary-pink);
            border: 2px solid var(--primary-pink);
        }

        .btn-secondary:hover {
            background: var(--primary-pink);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 16px rgba(233, 30, 99, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 1.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .auth-links {
            text-align: center;
            margin-top: 1.75rem;
            font-size: 0.9rem;
        }

        .auth-links a {
            color: var(--primary-pink);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.2s;
        }

        .auth-links a:hover {
            color: var(--dark-pink);
        }

        /* Main App Layout */
        .app-container {
            display: flex;
            min-height: 100vh;
            background: var(--light-gray);
        }

        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--primary-pink) 0%, var(--dark-pink) 100%);
            color: white;
            padding: 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 1000;
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.1);
        }

        .sidebar.mobile-hidden {
            transform: translateX(-100%);
        }

        .sidebar-header {
            text-align: center;
            padding: 2rem 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
            background: rgba(0, 0, 0, 0.1);
        }

        .sidebar-logo {
            font-size: 1.6rem;
            font-weight: 800;
            margin-bottom: 0.3rem;
            letter-spacing: -0.5px;
        }

        .sidebar-subtitle {
            font-size: 0.8rem;
            opacity: 0.85;
            font-weight: 500;
        }

        .nav-menu {
            list-style: none;
            padding: 1.5rem 0;
        }

        .nav-item {
            margin-bottom: 0.3rem;
            padding: 0 1rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 1rem 1.2rem;
            color: rgba(255, 255, 255, 0.85);
            text-decoration: none;
            transition: all 0.3s ease;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(4px);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .nav-link i {
            width: 22px;
            margin-right: 1rem;
            font-size: 1.1rem;
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        .main-content.full-width {
            margin-left: 0;
        }

        .top-bar {
            background: white;
            padding: 1.2rem 2rem;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--primary-pink);
            cursor: pointer;
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, var(--primary-pink), var(--accent-pink));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.95rem;
            box-shadow: 0 4px 12px rgba(233, 30, 99, 0.2);
        }

        .user-profile span {
            font-weight: 600;
            color: var(--dark-gray);
        }

        .logout-btn {
            background: linear-gradient(135deg, var(--error-red), #E53935);
            color: white;
            border: none;
            padding: 0.65rem 1.2rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.3);
        }

        /* Page Content */
        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
            animation: fadeInUp 0.4s ease;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary-pink), var(--dark-pink));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--neutral-gray);
            font-size: 0.95rem;
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.8rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary-pink), var(--accent-pink));
        }

        .stat-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 12px 32px rgba(233, 30, 99, 0.12);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.2rem;
        }

        .stat-title {
            font-size: 0.85rem;
            color: var(--neutral-gray);
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(255, 64, 129, 0.1));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-pink);
            font-size: 1.3rem;
        }

        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--dark-gray);
            letter-spacing: -1px;
        }

        .stat-unit {
            font-size: 1rem;
            color: var(--neutral-gray);
            margin-left: 0.3rem;
            font-weight: 600;
        }

        /* Camera Section */
        .camera-section {
            background: white;
            border-radius: 20px;
            padding: 1.8rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .camera-controls {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.2rem;
            flex-wrap: wrap;
        }

        .camera-view {
            width: 100%;
            height: 320px;
            background: #1a1a1a;
            border-radius: 16px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .camera-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: rgba(255, 255, 255, 0.8);
            font-size: 1.1rem;
        }

        .camera-placeholder i {
            font-size: 3.5rem;
            margin-bottom: 1.2rem;
            opacity: 0.6;
        }

        /* Controls */
        .controls-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .control-card {
            background: white;
            padding: 1.8rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
        }

        .control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1.2rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .control-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--dark-gray);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 56px;
            height: 30px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #E0E0E0;
            transition: .3s;
            border-radius: 30px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--primary-pink), var(--accent-pink));
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        .schedule-input {
            width: 100%;
            padding: 0.9rem 1.1rem;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            margin-top: 1rem;
            font-family: 'Inter', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }

        .schedule-input:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.08);
        }

        /* Pig Management */
        .pig-form {
            background: white;
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .pig-form h3 {
            margin-bottom: 1.5rem;
            color: var(--dark-gray);
            font-weight: 700;
            font-size: 1.3rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.2rem;
        }

        .pig-list {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .pig-list > div:first-child {
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, rgba(233, 30, 99, 0.08), rgba(240, 98, 146, 0.08));
            border-bottom: 1px solid var(--border-color);
        }

        .pig-list h3 {
            color: var(--dark-pink);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .pig-table {
            width: 100%;
            border-collapse: collapse;
        }

        .pig-table th,
        .pig-table td {
            padding: 1.2rem 1.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .pig-table th {
            background: var(--light-gray);
            font-weight: 700;
            color: var(--dark-gray);
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .pig-table tr:hover {
            background: rgba(233, 30, 99, 0.02);
        }

        .status-badge {
            padding: 0.35rem 0.9rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .status-active {
            background: rgba(76, 175, 80, 0.12);
            color: var(--success-green);
        }

        .status-sold {
            background: rgba(244, 67, 54, 0.12);
            color: var(--error-red);
        }

        .btn-sell {
            background: linear-gradient(135deg, var(--warning-orange), #FB8C00);
            color: white;
            padding: 0.6rem 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 0.6rem;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(255, 152, 0, 0.2);
            margin-bottom: 0.5rem;
        }

        .btn-sell:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(255, 152, 0, 0.3);
        }

        .btn-edit {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 0.6rem 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 0.6rem;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
            margin-bottom: 0.5rem;
        }

        .btn-edit:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(33, 150, 243, 0.3);
        }

        .btn-history {
            background: linear-gradient(135deg, #9C27B0, #7B1FA2);
            color: white;
            padding: 0.6rem 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 0.6rem;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(156, 39, 176, 0.2);
            margin-bottom: 0.5rem;
        }

        .btn-history:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(156, 39, 176, 0.3);
        }

        .btn-delete {
            background: linear-gradient(135deg, var(--error-red), #E53935);
            color: white;
            padding: 0.6rem 1.1rem;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.85rem;
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.2);
        }

        .btn-delete:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(244, 67, 54, 0.3);
        }

        /* Charts */
        .chart-container {
            background: white;
            padding: 1.8rem;
            border-radius: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .chart-header h3 {
            color: var(--dark-gray);
            font-weight: 700;
            font-size: 1.2rem;
        }

        .chart-filters {
            display: flex;
            gap: 0.8rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 0.7rem 1.1rem;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            background: white;
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--primary-pink);
            box-shadow: 0 0 0 4px rgba(233, 30, 99, 0.08);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 520px;
            max-height: 80vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.8rem;
            padding-bottom: 1.2rem;
            border-bottom: 2px solid var(--light-gray);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark-gray);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            color: var(--neutral-gray);
            cursor: pointer;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
        }

        .close-btn:hover {
            color: var(--dark-gray);
            background: var(--light-gray);
        }

        /* Alerts */
        .alert {
            padding: 1.2rem 1.5rem;
            margin: 1rem 0;
            border-radius: 14px;
            border-left: 4px solid;
            font-size: 0.9rem;
        }

        .alert-success {
            background: rgba(76, 175, 80, 0.08);
            border-left-color: var(--success-green);
            color: var(--success-green);
        }

        .alert-error {
            background: rgba(244, 67, 54, 0.08);
            border-left-color: var(--error-red);
            color: var(--error-red);
        }

        .alert-warning {
            background: rgba(255, 152, 0, 0.08);
            border-left-color: var(--warning-orange);
            color: var(--warning-orange);
        }

        .alert-info {
            background: rgba(233, 30, 99, 0.08);
            border-left-color: var(--primary-pink);
            color: var(--primary-pink);
        }

        /* Loading */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 3rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--light-pink);
            border-top: 4px solid var(--primary-pink);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Notifications Toast */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            background: white;
            padding: 1.2rem 1.8rem;
            border-radius: 16px;
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.15);
            border-left: 4px solid var(--primary-pink);
            z-index: 3000;
            transform: translateX(450px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            min-width: 300px;
            border: 1px solid var(--border-color);
        }

        .notification.show {
            transform: translateX(0);
        }

        /* Chart responsiveness */
        .chart-canvas {
            max-width: 100%;
            height: 320px !important;
        }

        /* Utility classes */
        .text-center { text-align: center; }
        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        .hidden { display: none !important; }
        .flex { display: flex; }
        .gap-1 { gap: 1rem; }
        .items-center { align-items: center; }
        .justify-between { justify-content: space-between; }

        /* Mobile-specific improvements */
        @media (max-width: 768px) {
            html, body {
                width: 100%;
                overflow-x: hidden;
            }

            .main-content {
                width: 100%;
                overflow-x: hidden;
                margin-left: 0 !important;
                padding: 1.5rem;
            }

            .page-content {
                width: 100%;
                overflow-x: hidden;
            }

            .sidebar {
                transform: translateX(-100%);
                width: 260px;
            }

            .sidebar.show {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: block;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .controls-section {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .auth-card {
                margin: 1.5rem;
                padding: 2rem;
            }

            .pig-form, .pig-list {
                width: 100%;
                overflow-x: auto;
            }

            .pig-table {
                width: 100%;
                min-width: 650px;
                display: block;
            }

            .pig-table td {
                white-space: nowrap;
            }

            .btn-edit, .btn-history, .btn-sell, .btn-delete {
                display: inline-block;
                margin: 0.25rem;
                padding: 0.5rem 0.8rem;
                font-size: 0.8rem;
            }

            .chart-container {
                width: 100%;
                overflow-x: auto;
                padding: 1.2rem;
            }

            canvas, .chart-canvas {
                width: 100% !important;
                height: 280px !important;
            }

            .chart-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .chart-filters {
                width: 100%;
                flex-wrap: wrap;
            }

            .filter-select {
                flex: 1;
                min-width: 120px;
            }

            .top-bar {
                padding: 1rem 1.5rem;
            }

            .page-title {
                font-size: 1.6rem;
            }

            .notification {
                right: 1rem;
                left: 1rem;
                min-width: auto;
            }

            .user-profile span {
                display: none;
            }

            .modal-content {
                width: 95%;
                max-width: 95%;
                padding: 1.5rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .stat-value {
                font-size: 1.8rem;
            }

            .camera-view {
                height: 250px;
            }

            .control-card {
                padding: 1.5rem;
            }

            /* Mobile table improvements */
            .pig-table-wrapper {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            /* Better touch targets for mobile */
            button, .btn {
                min-height: 44px;
                min-width: 44px;
            }

            /* Improve form inputs on mobile */
            .form-input, .schedule-input {
                font-size: 16px; /* Prevents zoom on iOS */
            }
        }

        @media (min-width: 769px) {
            .sidebar {
                transform: none !important;
            }

            .main-content {
                margin-left: 280px !important;
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, var(--secondary-pink), var(--primary-pink));
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, var(--primary-pink), var(--dark-pink));
        }

        /* Additional Modern Touches */
        select.form-input {
            cursor: pointer;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23E91E63' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            padding-right: 2.5rem;
            appearance: none;
        }

        .camera-section .chart-header h3 {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .camera-placeholder > div:last-child {
            font-size: 0.9rem;
            opacity: 0.6;
            margin-top: 0.8rem;
        }

        img#camImg {
            object-fit: cover;
        }

        #thermalContainer canvas {
            display: block;
            margin: 0 auto;
        }

        .report-section {
            width: 100%;
            overflow-x: auto;
        }

        .report-table {
            width: 100%;
            min-width: 700px;
        }
    </style>
</head>
<body>
    <!-- Authentication Pages -->
    <div id="authContainer" class="auth-container">
        <!-- Login Page -->
        <div id="loginPage" class="auth-card">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-piggy-bank"></i>
                </div>
                <h1>SwineCare</h1>
                <p>Swine Management & Health Monitoring System</p>
            </div>
            <form id="loginForm">
                <div class="form-group">
                    <label for="loginEmail">Email Address</label>
                    <input type="email" id="loginEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password</label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter your password" required>
                </div>
                <div class="checkbox-group">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Remember me</label>
                </div>
                <button type="submit" class="btn btn-primary">Sign In</button>
                <div class="auth-links">
                    <a href="#" onclick="showForgotPassword()">Forgot Password?</a> | 
                    <a href="#" onclick="showRegister()">Create Account</a>
                </div>
            </form>
        </div>

        <!-- Register Page -->
        <div id="registerPage" class="auth-card" style="display: none;">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-piggy-bank"></i>
                </div>
                <h1>Create Account</h1>
                <p>Join SwineCare Today</p>
            </div>
            <form id="registerForm">
                <div class="form-group">
                    <label for="registerName">Full Name</label>
                    <input type="text" id="registerName" class="form-input" placeholder="Enter your full name" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email Address</label>
                    <input type="email" id="registerEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password</label>
                    <input type="password" id="registerPassword" class="form-input" placeholder="Create a password" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm your password" required>
                </div>
                <button type="submit" class="btn btn-primary">Create Account</button>
                <div class="auth-links">
                    <a href="#" onclick="showLogin()">Already have an account? Sign In</a>
                </div>
            </form>
        </div>

        <!-- Forgot Password Page -->
        <div id="forgotPasswordPage" class="auth-card" style="display: none;">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-piggy-bank"></i>
                </div>
                <h1>Reset Password</h1>
                <p>Enter your email to reset password</p>
            </div>
            <form id="forgotPasswordForm">
                <div class="form-group">
                    <label for="resetEmail">Email Address</label>
                    <input type="email" id="resetEmail" class="form-input" placeholder="Enter your email" required>
                </div>
                <button type="submit" class="btn btn-primary">Send Reset Link</button>
                <div class="auth-links">
                    <a href="#" onclick="showLogin()">Back to Login</a>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="appContainer" class="app-container" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">SwineCare</div>
                <div class="sidebar-subtitle">IoT Monitoring System</div>
            </div>
            <ul class="nav-menu">
                <li class="nav-item">
                    <a href="#" class="nav-link active" onclick="showPage('dashboard')">
                        <i class="fas fa-tachometer-alt"></i>
                        Dashboard
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showPage('pigs')">
                        <i class="fas fa-piggy-bank"></i>
                        Hogs Management
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showPage('statistics')">
                        <i class="fas fa-chart-line"></i>
                        Data & Statistics
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showPage('notifications')">
                        <i class="fas fa-bell"></i>
                        Notifications
                    </a>
                </li>
                <li class="nav-item">
                    <a href="#" class="nav-link" onclick="showPage('reports')">
                        <i class="fas fa-file-pdf"></i>
                        Reports
                    </a>
                </li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Top Bar -->
            <div class="top-bar">
                <button class="mobile-menu-btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <h2 id="pageTitle" style="font-weight: 700; color: var(--dark-gray);">Dashboard</h2>
                <div class="user-profile">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <span id="userName">Farmer</span>
                    <button class="logout-btn" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page-content active">
                <div class="page-header">
                    <h1 class="page-title">Real-Time Monitoring Dashboard</h1>
                    <p class="page-subtitle">Monitor your swine health and environment in real-time</p>
                </div>

                <!-- Stats Grid -->
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Registered Hogs</span>
                            <div class="stat-icon">
                                <i class="fas fa-piggy-bank"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="pigCount">0</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Ambient Temperature</span>
                            <div class="stat-icon">
                                <i class="fas fa-thermometer-half"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="temperature">--<span class="stat-unit">°C</span></div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Humidity</span>
                            <div class="stat-icon">
                                <i class="fas fa-tint"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="humidity">--<span class="stat-unit">%</span></div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <span class="stat-title">Hogs Body Temp</span>
                            <div class="stat-icon">
                                <i class="fas fa-heartbeat"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="pigBodyTemp">--<span class="stat-unit">°C</span></div>
                    </div>
                </div>
				
                <!-- Camera Section -->
				<div class="camera-section">
				  <div class="chart-header">
					<h3>Live Camera Monitoring</h3>
					<div class="camera-controls">
					  <button class="btn btn-secondary" onclick="switchCamera('behavior')">
						<i class="fas fa-eye"></i> Behavior Cam
					  </button>
					  <button class="btn btn-secondary" onclick="switchCamera('thermal')">
						<i class="fas fa-thermometer-half"></i> Thermal Cam
					  </button>
					</div>
				  </div>

				  <div class="camera-view">
					<div class="camera-placeholder" id="cameraFeed">
					  <img id="camImg" src=""
						   alt="Camera Feed"
						   style="max-width: 100%; height: 100%; border-radius: 16px; display: none;" />

					  <div id="thermalContainer" style="display: none; text-align: center;">
						<canvas id="canvas" width="320" height="240"
								style="border-radius: 16px; background: black; max-width: 100%;"></canvas>
					  </div>

					  <div id="camPlaceholder" style="text-align: center; color: white;">
						<i class="fas fa-video"></i>
						<div>Live Camera Feed - Behavior Monitoring</div>
						<div>Waiting for ESP32 Camera...</div>
					  </div>
					</div>
				  </div>
				</div>				
				
                <!-- Controls Section -->
                <div class="controls-section">
                    <div class="control-card">
                        <div class="control-header">
                            <span class="control-title"><i class="fas fa-bowl-rice" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Automatic Feeder</span>
                            <label class="switch">
                                <input type="checkbox" id="feederSwitch" onchange="toggleFeeder()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div>
                            <label for="feedSchedule">Feeding Schedule</label>
                            <input type="time" id="feedSchedule" class="schedule-input" value="08:00">
                            <input type="time" id="feedSchedule2" class="schedule-input" value="16:00" style="margin-top: 0.5rem;">
                            <button class="btn btn-secondary mt-2" onclick="manualFeed()" style="width: 100%;">
                                <i class="fas fa-play"></i> Feed Now
                            </button>
                        </div>
                    </div>

                    <div class="control-card">
                        <div class="control-header">
                            <span class="control-title"><i class="fas fa-shower" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Water Shower</span>
                            <label class="switch">
                                <input type="checkbox" id="showerSwitch" onchange="toggleShower()">
                                <span class="slider"></span>
                            </label>
                        </div>
                        <div>
                            <label for="showerSchedule">Shower Schedule</label>
                            <input type="time" id="showerSchedule" class="schedule-input" value="12:00">
                            <input type="time" id="showerSchedule2" class="schedule-input" value="18:00" style="margin-top: 0.5rem;">
                            <button class="btn btn-secondary mt-2" onclick="manualShower()" style="width: 100%;">
                                <i class="fas fa-shower"></i> Shower Now
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pig Management Page -->
            <div id="pigsPage" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">Hogs Management</h1>
                    <p class="page-subtitle">Register and manage your swine inventory</p>
                </div>

                <!-- Pig Registration Form -->
                <div class="pig-form">
                    <h3><i class="fas fa-plus-circle" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Register New Hog</h3>
                    <form id="pigForm">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pigTag">Tag Number</label>
                                <input type="text" id="pigTag" class="form-input" placeholder="e.g., HOG-001" required>
                            </div>
                            <div class="form-group">
                                <label for="pigBreed">Breed</label>
                                <select id="pigBreed" class="form-input" required>
                                    <option value="">Select Breed</option>
                                    <option value="Philippine Native">Philippine Native</option>
                                    <option value="Landrace">Landrace</option>
                                    <option value="Duroc">Duroc</option>
                                    <option value="Yorkshire">Yorkshire</option>
                                    <option value="Hampshire">Hampshire</option>
                                    <option value="Berkshire">Berkshire</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pigAge">Age (months)</label>
                                <input type="number" id="pigAge" class="form-input" min="1" placeholder="Enter age" required>
                            </div>
                            <div class="form-group">
                                <label for="pigWeight">Weight (kg)</label>
                                <input type="number" id="pigWeight" class="form-input" step="0.1" min="1" placeholder="Enter weight" required>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="pigGender">Gender</label>
                                <select id="pigGender" class="form-input" required>
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="pigLength">Length (cm)</label>
                                <input type="number" id="pigLength" class="form-input" min="10" placeholder="Enter length" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary"><i class="fas fa-check"></i> Register Hog</button>
                    </form>
                </div>

                <!-- Pig List -->
                <div class="pig-list">
                    <div>
                        <h3><i class="fas fa-list" style="margin-right: 0.5rem;"></i> Registered Hogs</h3>
                    </div>
                    <div class="pig-table-wrapper">
                        <table class="pig-table">
                            <thead>
                                <tr>
                                    <th>Tag #</th>
                                    <th>Breed</th>
                                    <th>Age (months)</th>
                                    <th>Weight (kg)</th>
                                    <th>Length (cm)</th>
                                    <th>Gender</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="pigTableBody">
                                <!-- Pig rows will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Statistics Page -->
            <div id="statisticsPage" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">Data & Statistics</h1>
                    <p class="page-subtitle">Analyze your swine health and environmental data</p>
                </div>

                <!-- Pig Comparison Section -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-balance-scale" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Hog Comparison</h3>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label for="pig1Select">First Hog</label>
                            <select id="pig1Select" class="filter-select" style="width: 100%;">
                                <option value="">Select First Hog</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="pig2Select">Second Hog (Compare)</label>
                            <select id="pig2Select" class="filter-select" style="width: 100%;">
                                <option value="">Select Second Hog</option>
                            </select>
                        </div>
                    </div>
                    <div style="text-align: center; margin-bottom: 1rem;">
                        <button class="btn btn-primary" onclick="updateComparison()" style="min-width: 200px;">
                            <i class="fas fa-chart-bar"></i> Compare Hog
                        </button>
                    </div>
                    
                    <!-- Comparison Summary -->
                    <div id="comparisonSummary" style="display: none; margin-bottom: 2rem;">
                        <div style="background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(240, 98, 146, 0.1)); padding: 1.5rem; border-radius: 16px; border: 2px solid var(--light-pink);">
                            <h4 style="color: var(--dark-pink); margin-bottom: 1rem; font-size: 1.2rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-clipboard-check"></i> Comparison Summary
                            </h4>
                            <div id="summaryContent" style="display: grid; gap: 0.8rem;"></div>
                        </div>
                    </div>

                    <div id="comparisonChartContainer" style="min-height: 300px;">
                        <p style="text-align: center; color: var(--neutral-gray); padding: 3rem;">
                            <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                            Select two Hogs to compare their growth history
                        </p>
                    </div>
                    
                    <!-- Charts for each metric -->
                    <div id="comparisonChartsGrid" style="display: none; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                        <div>
                            <h4 style="color: var(--dark-pink); margin-bottom: 1rem; text-align: center;">Age Comparison</h4>
                            <canvas id="ageComparisonChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="color: var(--dark-pink); margin-bottom: 1rem; text-align: center;">Weight Comparison</h4>
                            <canvas id="weightComparisonChart" style="max-height: 300px;"></canvas>
                        </div>
                        <div>
                            <h4 style="color: var(--dark-pink); margin-bottom: 1rem; text-align: center;">Length Comparison</h4>
                            <canvas id="lengthComparisonChart" style="max-height: 300px;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Chart Filters -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-filter" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Data Filters</h3>
                        <div class="chart-filters">
                            <select id="dataFilter" class="filter-select">
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                                <option value="30d">Last 30 Days</option>
                            </select>
                            <input type="date" id="customDate" class="filter-select">
                            <button class="btn btn-secondary" onclick="updateCharts()">
                                <i class="fas fa-sync"></i> Update
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Temperature Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-temperature-high" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Temperature Monitoring</h3>
                    </div>
                    <canvas id="temperatureChart" class="chart-canvas"></canvas>
                </div>

                <!-- Humidity Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-tint" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Humidity Monitoring</h3>
                    </div>
                    <canvas id="humidityChart" class="chart-canvas"></canvas>
                </div>

                <!-- Pig Body Temperature Chart -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-heartbeat" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Hog Body Temperature</h3>
                    </div>
                    <canvas id="pigTempChart" class="chart-canvas"></canvas>
                </div>
            </div>

            <!-- Notifications Page -->
            <div id="notificationsPage" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">Notifications & Alerts</h1>
                    <p class="page-subtitle">Monitor health warnings and system alerts</p>
                </div>

                <div id="notificationsList" style="display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Notifications will be populated here -->
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reportsPage" class="page-content">
                <div class="page-header">
                    <h1 class="page-title">Reports & Export</h1>
                    <p class="page-subtitle">Generate and export detailed reports</p>
                </div>

                <!-- Report Filters -->
                <div class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-file-alt" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Report Generation</h3>
                        <div class="chart-filters">
                            <input type="date" id="reportStartDate" class="filter-select">
                            <input type="date" id="reportEndDate" class="filter-select">
                            <button class="btn btn-primary" onclick="generateReport()">
                                <i class="fas fa-file-pdf"></i> Generate PDF Report
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Report Preview -->
                <div id="reportPreview" class="chart-container">
                    <div class="chart-header">
                        <h3><i class="fas fa-eye" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Report Preview</h3>
                    </div>
                    <div id="reportContent">
                        <p style="text-align: center; color: var(--neutral-gray); padding: 3rem;">
                            <i class="fas fa-file-pdf" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                            Select date range and click "Generate PDF Report" to preview
                        </p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Sell Pig Modal -->
    <div id="sellPigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-dollar-sign" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Sell Hog</h3>
                <button class="close-btn" onclick="closeSellModal()">&times;</button>
            </div>
            <form id="sellPigForm">
                <div class="form-group">
                    <label for="sellAmount">Sale Amount (₱)</label>
                    <input type="number" id="sellAmount" class="form-input" step="0.01" min="0" placeholder="Enter sale amount" required>
                </div>
                <div class="form-group">
                    <label for="buyerName">Buyer Name (Optional)</label>
                    <input type="text" id="buyerName" class="form-input" placeholder="Enter buyer name">
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeSellModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;">Confirm Sale</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Delete Pig Confirmation Modal -->
    <div id="deletePigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-exclamation-triangle" style="margin-right: 0.5rem; color: var(--error-red);"></i> Delete Hog</h3>
                <button class="close-btn" onclick="closeDeleteModal()">&times;</button>
            </div>
            <div style="margin-bottom: 2rem;">
                <p style="font-size: 1rem; line-height: 1.6;">Are you sure you want to delete this Hog from the system?</p>
                <p style="color: var(--error-red); margin-top: 1rem; font-weight: 600; background: rgba(244, 67, 54, 0.08); padding: 0.75rem; border-radius: 8px;">
                    <i class="fas fa-info-circle"></i> This action cannot be undone.
                </p>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()" style="flex: 1;">Cancel</button>
                <button type="button" class="btn-delete" onclick="confirmDelete()" style="flex: 1;"><i class="fas fa-trash"></i> Delete Hog</button>
            </div>
        </div>
    </div>

    <!-- Edit Pig Modal -->
    <div id="editPigModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-edit" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Update Hog Information</h3>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <form id="editPigForm">
                <div class="form-group">
                    <label for="editPigAge">Age (months)</label>
                    <input type="number" id="editPigAge" class="form-input" min="1" required>
                </div>
                <div class="form-group">
                    <label for="editPigWeight">Weight (kg)</label>
                    <input type="number" id="editPigWeight" class="form-input" step="0.1" min="1" required>
                </div>
                <div class="form-group">
                    <label for="editPigLength">Length (cm)</label>
                    <input type="number" id="editPigLength" class="form-input" min="10" required>
                </div>
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeEditModal()" style="flex: 1;">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="flex: 1;"><i class="fas fa-check"></i> Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit History Modal -->
    <div id="historyModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h3 class="modal-title"><i class="fas fa-history" style="margin-right: 0.5rem; color: var(--primary-pink);"></i> Growth Record</h3>
                <button class="close-btn" onclick="closeHistoryModal()">&times;</button>
            </div>
            <div id="historyContent" style="max-height: 400px; overflow-y: auto;">
                <p style="text-align: center; color: var(--neutral-gray); padding: 2rem;">Loading history...</p>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="notificationToast" class="notification">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <i class="fas fa-check-circle" style="color: var(--primary-pink); font-size: 1.3rem;"></i>
            <span id="notificationMessage" style="font-weight: 500;"></span>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBAKTPpU7RsfqIrOrp9o98JnCL-RbUVWNs",
            authDomain: "capstone-996a3.firebaseapp.com",
            projectId: "capstone-996a3",
            storageBucket: "capstone-996a3.firebasestorage.app",
            messagingSenderId: "297091452987",
            appId: "1:297091452987:web:a68ccf7b53b6b69d80cc1e",
            databaseURL: "https://capstone-996a3-default-rtdb.firebaseio.com/"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();
        const firestore = firebase.firestore();

        // Enable Firebase persistence
        auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
            .catch((error) => {
                console.error("Error setting persistence:", error);
            });

        // Global Variables
        let currentUser = null;
        let currentPigToSell = null;
        let currentPigToDelete = null;
        let currentPigToEdit = null;
        let currentPigForHistory = null;
        let charts = {};
        let chartInstances = {};
        let simulationInterval;
		let pig_temp = null;
		let ambient_temp = null;
		let ambient_humidity = null;

        // Authentication Functions
        function showLogin() {
            destroyAllCharts();
            document.getElementById('loginPage').style.display = 'block';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('forgotPasswordPage').style.display = 'none';
        }

        function showRegister() {
            destroyAllCharts();
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'block';
            document.getElementById('forgotPasswordPage').style.display = 'none';
        }

        function showForgotPassword() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('registerPage').style.display = 'none';
            document.getElementById('forgotPasswordPage').style.display = 'block';
        }

        function destroyChart(chartId) {
            if (chartInstances[chartId]) {
                chartInstances[chartId].destroy();
                delete chartInstances[chartId];
            }
        }

        function destroyAllCharts() {
            Object.keys(chartInstances).forEach(chartId => {
                destroyChart(chartId);
            });
        }

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const rememberMe = document.getElementById('rememberMe').checked;

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                currentUser = userCredential.user;
                
                if (rememberMe) {
                    localStorage.setItem('rememberMe', 'true');
                    localStorage.setItem('userEmail', email);
                } else {
                    localStorage.removeItem('rememberMe');
                    localStorage.removeItem('userEmail');
                }

                showMainApp();
                startDataSimulation();
                showNotification('Welcome back to SwineCare!', 'success');
            } catch (error) {
                showNotification(`Incorrect Email/Password`, 'error');
            }
        });

        // Register Form Handler
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showNotification('Passwords do not match', 'error');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                await userCredential.user.updateProfile({ displayName: name });
                
                await firestore.collection('users').doc(userCredential.user.uid).set({
                    name: name,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                currentUser = userCredential.user;
                showMainApp();
                startDataSimulation();
                showNotification('Account created successfully! Welcome to SwineCare!', 'success');
            } catch (error) {
                showNotification(`Registration failed: ${error.message}`, 'error');
            }
        });

        // Forgot Password Handler
        document.getElementById('forgotPasswordForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value;

            try {
                await auth.sendPasswordResetEmail(email);
                showNotification('Password reset email sent successfully!', 'success');
                showLogin();
            } catch (error) {
                showNotification(`Reset failed: ${error.message}`, 'error');
            }
        });

        // Main App Functions
        function showMainApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'flex';
            
            const displayName = currentUser.displayName || 'Farmer';
            document.getElementById('userName').textContent = displayName;
            document.getElementById('userAvatar').textContent = displayName.charAt(0).toUpperCase();
            
            loadPigs();
            setupRealtimeListeners();
            
            setTimeout(() => {
                initializeCharts();
            }, 100);
        }

        function logout() {
            destroyAllCharts();
            
            auth.signOut();
            stopDataSimulation();
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
            showLogin();
            showNotification('Logged out successfully', 'success');
        }

        // Navigation
        function showPage(pageId) {
            const pages = document.querySelectorAll('.page-content');
            pages.forEach(page => page.classList.remove('active'));
            
            document.getElementById(pageId + 'Page').classList.add('active');
            
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            const titles = {
                'dashboard': 'Dashboard',
                'pigs': 'Pig Management',
                'statistics': 'Data & Statistics',
                'notifications': 'Notifications',
                'reports': 'Reports'
            };
            document.getElementById('pageTitle').textContent = titles[pageId];
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            sidebar.classList.toggle('mobile-hidden');
            sidebar.classList.toggle('show');
            mainContent.classList.toggle('full-width');
        }

        // IoT Data Simulation
        function startDataSimulation() {
            simulationInterval = setInterval(() => {
                if (ambient_temp) {
                    ambient_temp = parseFloat(ambient_temp).toFixed(2);
                }
				updateSensorData(pig_temp, ambient_humidity, ambient_temp);
                checkHealthAlerts();
            }, 5000);
            
			updateSensorData(pig_temp, ambient_humidity, ambient_temp);
        }

        function stopDataSimulation() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }
        }

        function updateSensorData(pig_temp = 0, H = 0, ambient_temp = 0) {
            if (!currentUser) return;

            const temperature = ambient_temp;
            const humidity = H;
            const pigBodyTemp = pig_temp;
			
            document.getElementById('temperature').innerHTML = `${temperature}<span class="stat-unit">°C</span>`;
            document.getElementById('humidity').innerHTML = `${humidity}<span class="stat-unit">%</span>`;
            document.getElementById('pigBodyTemp').innerHTML = `${pigBodyTemp}<span class="stat-unit">°C</span>`;

            const timestamp = Date.now();
            const sensorData = {
                temperature: parseFloat(temperature),
                humidity: parseFloat(humidity),
                pigBodyTemp: parseFloat(pigBodyTemp),
                timestamp: timestamp,
                userId: currentUser.uid
            };

            database.ref(`sensorData/${currentUser.uid}/${timestamp}`).set(sensorData);
        }

        function checkHealthAlerts() {
            const temperature = parseFloat(document.getElementById('temperature').textContent);
            const humidity = parseFloat(document.getElementById('humidity').textContent);
            const pigBodyTemp = parseFloat(document.getElementById('pigBodyTemp').textContent);

            if (temperature > 35) {
                addNotification('High Temperature Alert', `Temperature is ${temperature}°C - Above normal range`, 'warning');
            }
			
            if (humidity > 85) {
                addNotification('High Humidity Alert', `Humidity is ${humidity}% - Risk of disease`, 'warning');
            }
			
			if (pigBodyTemp > 40) {
                addNotification('Pig Health Alert', `Pig body temperature is ${pigBodyTemp}°C - Possible fever`, 'error');
            }
        }

		// Camera Functions
		const CAMERA_URLS = {
		  behavior: "http://cam_stream.local:81/stream"
		};

		const THERMAL_WS_URL = "ws://heatmap/thermal";
		const CONTROL_WS_URL = "ws://heatmap/control";
		let controlConnecting = false;

		const camImg = document.getElementById('camImg');
		const thermalContainer = document.getElementById('thermalContainer');
		const camPlaceholder = document.getElementById('camPlaceholder');
		
		const canvas = document.getElementById('canvas');
		const ctx = canvas.getContext('2d');

		const cols = 32, rows = 24;
		const smallCanvas = document.createElement('canvas');
		smallCanvas.width = cols;
		smallCanvas.height = rows;
		const smallCtx = smallCanvas.getContext('2d');

		let thermalWs = null;
		let controlWs = null;

		let controlConnected = false;
		let controlQueue = [];
		let controlReconnectDelay = 1000;
		const CONTROL_MAX_RECONNECT_DELAY = 30000;

		let processing = false;

		function connectControlWS(url = CONTROL_WS_URL) {
		  if (controlWs && (controlWs.readyState === WebSocket.OPEN || controlWs.readyState === WebSocket.CONNECTING)) {
			return;
		  }
		  controlConnecting = true;

		  try {
			controlWs = new WebSocket(url);
			controlWs.onopen = () => {
			  console.log('[ControlWS] connected');
			  controlConnected = true;
			  controlConnecting = false;
			  controlReconnectDelay = 1000;
			  while (controlQueue.length) {
				const m = controlQueue.shift();
				_sendControlNow(m);
			  }
			};

			controlWs.onmessage = (evt) => { console.log('[ControlWS] recv:', evt.data); };

			controlWs.onclose = (evt) => {
			  console.warn('[ControlWS] closed', 'code=', evt.code, 'reason=', evt.reason);
			  controlConnected = false;
			  controlWs = null;
			  controlConnecting = false;
			  setTimeout(() => {
				controlReconnectDelay = Math.min(CONTROL_MAX_RECONNECT_DELAY, Math.floor(controlReconnectDelay * 1.5));
				connectControlWS(url);
			  }, controlReconnectDelay);
			};

			controlWs.onerror = (err) => {
			  console.error('[ControlWS] error', err);
			};

		  } catch (err) {
			console.error('[ControlWS] connect exception', err);
			controlConnected = false;
			controlConnecting = false;
		  }
		}

		function _sendControlNow(out) {
		  if (!controlWs || controlWs.readyState !== WebSocket.OPEN) {
			controlQueue.push(out);
			return;
		  }
		  try {
			controlWs.send(out);
			console.log('[ControlWS] sent', out);
		  } catch (e) {
			console.error('[ControlWS] send failed, queueing', e);
			controlQueue.push(out);
		  }
		}

		function sendControl(payload) {
		  const out = (typeof payload === 'object') ? JSON.stringify(payload) : String(payload);

		  if (controlWs && controlWs.readyState === WebSocket.OPEN && controlConnected) {
			_sendControlNow(out);
			return;
		  }

		  controlQueue.push(out);
		  console.warn('[ControlWS] not connected — queued command:', out);

		  if (!controlWs || controlWs.readyState === WebSocket.CLOSED) {
			if (!controlConnecting) connectControlWS();
		  }
		}

		connectControlWS();

		function switchCamera(type) {
		  if (type === 'behavior') {
			stopThermalFeed();
			camImg.src = CAMERA_URLS.behavior;
			camImg.style.display = "block";
			thermalContainer.style.display = "none";
			camPlaceholder.style.display = "none";
		  } else if (type === 'thermal') {
			camImg.style.display = "none";
			camPlaceholder.style.display = "none";
			thermalContainer.style.display = "block";
			startThermalFeed();
		  }
		}

		function startThermalFeed() {
		  if (thermalWs && thermalWs.readyState === WebSocket.OPEN) return;
		  thermalWs = new WebSocket(THERMAL_WS_URL);
		  thermalWs.binaryType = "arraybuffer";

		  thermalWs.onopen = () => console.log("[ThermalWS] Thermal connected");
		  thermalWs.onclose = () => {
			console.warn("[ThermalWS] Disconnected, retrying...");
			setTimeout(startThermalFeed, 2000);
		  };

		  thermalWs.onmessage = async (e) => {
			if (e.data instanceof ArrayBuffer) {
			  const floats = new Float32Array(e.data);
			  if (floats.length === cols * rows) {
				drawFloatFrame(floats);
			  }
			  return;
			}

			try {
			  let text;
			  if (typeof e.data === "string") {
				text = e.data;
			  } else if (e.data instanceof Blob) {
				text = await e.data.text();
			  } else {
				return;
			  }

			  const obj = JSON.parse(text);

			  if (obj && obj.type === "ta" && obj.ta !== undefined) {
				const taVal = Number(obj.ta);
				if (Number.isFinite(taVal)) {
				  ambient_temp = taVal;
				}
			  } else if (obj && obj.type === "dht" && obj.humidity !== undefined) {
				const humVal = Number(obj.humidity);
				if (Number.isFinite(humVal)) {
				  ambient_humidity = humVal;
				}
			  } else if (obj && obj.type === "meta") {
				if (obj.ta !== undefined) {
				  const taVal = Number(obj.ta);
				  if (Number.isFinite(taVal)) ambient_temp = taVal;
				}
				if (obj.humidity !== undefined) {
				  const humVal = Number(obj.humidity);
				  if (Number.isFinite(humVal)) ambient_humidity = humVal;
				}
			  }
			} catch (err) {
			  console.warn("[ThermalWS] Failed to parse text message:", err);
			}
		  };
		}

		function stopThermalFeed() {
		  if (thermalWs) {
			try { thermalWs.close(); } catch (e) {}
			thermalWs = null;
		  }
		}

		function lerp(a, b, t) { return a + (b - a) * t; }

		function getColorForValue(val, vminLocal, vmaxLocal, cmap = 'turbo') {
		  if (!isFinite(val)) return [0, 0, 0, 255];
		  if (vminLocal === vmaxLocal) { vminLocal -= 0.5; vmaxLocal += 0.5; }
		  const t = Math.max(0, Math.min(1, (val - vminLocal) / (vmaxLocal - vminLocal)));
		  const stops = [
			[0.0, [48, 18, 59]],
			[0.25, [18, 102, 173]],
			[0.5, [28, 179, 128]],
			[0.75, [248, 182, 35]],
			[1.0, [181, 0, 0]]
		  ];
		  for (let i = 0; i < stops.length - 1; i++) {
			const t0 = stops[i][0], t1 = stops[i + 1][0];
			if (t >= t0 && t <= t1) {
			  const local = (t - t0) / (t1 - t0);
			  const c0 = stops[i][1], c1 = stops[i + 1][1];
			  return [
				Math.round(lerp(c0[0], c1[0], local)),
				Math.round(lerp(c0[1], c1[1], local)),
				Math.round(lerp(c0[2], c1[2], local)),
				255
			  ];
			}
		  }
		  return [255, 0, 255, 255];
		}

		function drawFloatFrame(floats) {
		  if (processing) return;
		  processing = true;

		  let obsMin = Infinity, obsMax = -Infinity;
		  for (const v of floats) {
			if (isFinite(v)) {
			  if (v < obsMin) obsMin = v;
			  if (v > obsMax) obsMax = v;
			}
		  }

		  pig_temp = isFinite(obsMax) ? obsMax.toFixed(2) : '-';

		  const vmin = isFinite(obsMin) ? obsMin : 0;
		  const vmax = isFinite(obsMax) ? obsMax : vmin + 1;

		  const img = smallCtx.createImageData(cols, rows);
		  for (let r = 0; r < rows; r++) {
			for (let c = 0; c < cols; c++) {
			  const idx = r * cols + c;
			  const v = floats[idx];
			  const col = getColorForValue(v, vmin, vmax, 'turbo');
			  const p = idx * 4;
			  img.data[p + 0] = col[0];
			  img.data[p + 1] = col[1];
			  img.data[p + 2] = col[2];
			  img.data[p + 3] = 255;
			}
		  }
		  smallCtx.putImageData(img, 0, 0);

		  ctx.clearRect(0, 0, canvas.width, canvas.height);
		  ctx.save();
		  ctx.imageSmoothingEnabled = false;
		  ctx.translate(canvas.width, 0);
		  ctx.scale(-1, 1);
		  ctx.drawImage(smallCanvas, 0, 0, canvas.width, canvas.height);
		  ctx.restore();

		  processing = false;
		}

		document.addEventListener("DOMContentLoaded", () => {
		  switchCamera('behavior');
		});

		function toggleFeeder() {
		  const isEnabled = document.getElementById('feederSwitch').checked;
		  showNotification(`Automatic Feeder ${isEnabled ? 'Enabled' : 'Disabled'}`, 'success');

		  if (currentUser) {
			database.ref(`controls/${currentUser.uid}/feeder`).set({
			  enabled: isEnabled,
			  lastUpdated: Date.now()
			});
		  }

		  sendControl({
			cmd: 'feeder',
			state: isEnabled ? 'on' : 'off',
			uid: currentUser ? currentUser.uid : undefined,
			ts: Date.now()
		  });
		}

		function toggleShower() {
		  const isEnabled = document.getElementById('showerSwitch').checked;
		  showNotification(`Water Shower ${isEnabled ? 'Enabled' : 'Disabled'}`, 'success');

		  if (currentUser) {
			database.ref(`controls/${currentUser.uid}/shower`).set({
			  enabled: isEnabled,
			  lastUpdated: Date.now()
			});
		  }

		  sendControl({
			cmd: 'valve',
			state: isEnabled ? 'on' : 'off',
			target: 'shower',
			uid: currentUser ? currentUser.uid : undefined,
			ts: Date.now()
		  });
		}

		function manualFeed() {
		  showNotification('Manual feeding activated', 'success');
		  addNotification('Manual Feed', 'Manual feeding session started', 'info');

		  const simulatedAmount = 0.2;
		  if (currentUser) {
			database.ref(`feedLogs/${currentUser.uid}/${Date.now()}`).set({
			  type: 'manual',
			  timestamp: Date.now(),
			  amount: `${simulatedAmount}kg`
			});
		  }

		  sendControl({
			cmd: 'feed',
			amount: simulatedAmount,
			uid: currentUser ? currentUser.uid : undefined,
			ts: Date.now()
		  });
		}

		function manualShower() {
		  showNotification('Water shower activated', 'success');
		  addNotification('Manual Shower', 'Water shower session started', 'info');

		  const simulatedDurationMinutes = 10;
		  if (currentUser) {
			database.ref(`showerLogs/${currentUser.uid}/${Date.now()}`).set({
			  type: 'manual',
			  timestamp: Date.now(),
			  duration: `${simulatedDurationMinutes} minutes`
			});
		  }

		  sendControl({ cmd: 'valve', state: 'on', target: 'shower', uid: currentUser ? currentUser.uid : undefined, ts: Date.now() });

		  setTimeout(() => {
			sendControl({ cmd: 'valve', state: 'off', target: 'shower', uid: currentUser ? currentUser.uid : undefined, ts: Date.now() });
			addNotification('Manual Shower', 'Water shower session ended', 'info');
		  }, simulatedDurationMinutes * 60 * 1000);
		}

        // Pig Management Functions
        document.getElementById('pigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const pigData = {
                tagNumber: document.getElementById('pigTag').value,
                breed: document.getElementById('pigBreed').value,
                age: parseInt(document.getElementById('pigAge').value),
                weight: parseFloat(document.getElementById('pigWeight').value),
                length: parseInt(document.getElementById('pigLength').value),
                gender: document.getElementById('pigGender').value,
                status: 'active',
                registrationDate: Date.now(),
                userId: currentUser.uid
            };

            try {
                const duplicateCheck = await firestore.collection('pigs')
                    .where('userId', '==', currentUser.uid)
                    .where('tagNumber', '==', pigData.tagNumber)
                    .get();

                if (!duplicateCheck.empty) {
                    showNotification('A pig with this tag number already exists!', 'error');
                    return;
                }

                await firestore.collection('pigs').add(pigData);
                document.getElementById('pigForm').reset();
                loadPigs();
                showNotification('Pig registered successfully!', 'success');
            } catch (error) {
                showNotification(`Registration failed: ${error.message}`, 'error');
            }
        });

        async function loadPigs() {
            if (!currentUser) return;

            try {
                const snapshot = await firestore.collection('pigs')
                    .where('userId', '==', currentUser.uid)
                    .get();

                const tableBody = document.getElementById('pigTableBody');
                tableBody.innerHTML = '';
                
                // Update dropdowns for comparison
                const pig1Select = document.getElementById('pig1Select');
                const pig2Select = document.getElementById('pig2Select');
                
                if (pig1Select && pig2Select) {
                    const currentPig1 = pig1Select.value;
                    const currentPig2 = pig2Select.value;
                    
                    pig1Select.innerHTML = '<option value="">Select First Hog</option>';
                    pig2Select.innerHTML = '<option value="">Select Second Hog</option>';
                }
                
                let totalPigs = 0;
                
                snapshot.forEach(doc => {
                    const pig = doc.data();
                    totalPigs++;
                    
                    // Update table
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${pig.tagNumber}</strong></td>
                        <td>${pig.breed}</td>
                        <td>${pig.age}</td>
                        <td>${pig.weight}</td>
                        <td>${pig.length}</td>
                        <td>${pig.gender}</td>
                        <td><span class="status-badge status-${pig.status}">${pig.status}</span></td>
                        <td>
    ${pig.status !== 'sold' ? 
        `<button class="btn-edit" onclick="openEditModal('${doc.id}')">
            <i class="fas fa-edit"></i> Update
        </button>
        <button class="btn-history" onclick="showPigGrowthAnalysis('${doc.id}')">
            <i class="fas fa-chart-line"></i> Growth
        </button>
        <button class="btn-sell" onclick="openSellModal('${doc.id}')">
            <i class="fas fa-dollar-sign"></i> Sell
        </button>
        <button class="btn-delete" onclick="openDeleteModal('${doc.id}')">
            <i class="fas fa-trash"></i> Delete
        </button>` : 
        '<span style="color: var(--neutral-gray);">Sold</span>'
    }
</td>
                    `;
                    tableBody.appendChild(row);
                    
                    // Update dropdowns for all pigs (not just healthy ones)
                    if (pig1Select && pig2Select) {
                        const option1 = document.createElement('option');
                        option1.value = doc.id;
                        option1.textContent = `${pig.tagNumber} - ${pig.breed} (${pig.status})`;
                        pig1Select.appendChild(option1);
                        
                        const option2 = document.createElement('option');
                        option2.value = doc.id;
                        option2.textContent = `${pig.tagNumber} - ${pig.breed} (${pig.status})`;
                        pig2Select.appendChild(option2);
                    }
                });

                document.getElementById('pigCount').textContent = totalPigs;
            } catch (error) {
                showNotification(`Failed to load pigs: ${error.message}`, 'error');
            }
        }

        function openSellModal(pigId) {
            currentPigToSell = pigId;
            document.getElementById('sellPigModal').classList.add('show');
        }

        function closeSellModal() {
            currentPigToSell = null;
            document.getElementById('sellPigModal').classList.remove('show');
            document.getElementById('sellPigForm').reset();
        }

        function openDeleteModal(pigId) {
            currentPigToDelete = pigId;
            document.getElementById('deletePigModal').classList.add('show');
        }

        function closeDeleteModal() {
            currentPigToDelete = null;
            document.getElementById('deletePigModal').classList.remove('show');
        }

        function openEditModal(pigId) {
            currentPigToEdit = pigId;
            
            firestore.collection('pigs').doc(pigId).get().then(doc => {
                if (doc.exists) {
                    const pig = doc.data();
                    document.getElementById('editPigAge').value = pig.age;
                    document.getElementById('editPigWeight').value = pig.weight;
                    document.getElementById('editPigLength').value = pig.length;
                    document.getElementById('editPigModal').classList.add('show');
                }
            });
        }

        function closeEditModal() {
            currentPigToEdit = null;
            document.getElementById('editPigModal').classList.remove('show');
            document.getElementById('editPigForm').reset();
        }

        function openHistoryModal(pigId) {
            currentPigForHistory = pigId;
            document.getElementById('historyModal').classList.add('show');
            loadEditHistory(pigId);
        }

        function closeHistoryModal() {
            currentPigForHistory = null;
            document.getElementById('historyModal').classList.remove('show');
        }

        async function loadEditHistory(pigId) {
            const historyContent = document.getElementById('historyContent');
            
            try {
                const historySnapshot = await firestore.collection('pigEditHistory')
                    .where('pigId', '==', pigId)
                    .orderBy('timestamp', 'desc')
                    .get();

                if (historySnapshot.empty) {
                    historyContent.innerHTML = '<p style="text-align: center; color: var(--neutral-gray); padding: 2rem;">No edit history available.</p>';
                    return;
                }

                let historyHTML = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
                
                historySnapshot.forEach(doc => {
                    const history = doc.data();
                    const date = new Date(history.timestamp).toLocaleString();
                    
                    historyHTML += `
                        <div style="background: var(--light-gray); padding: 1.2rem; border-radius: 12px; border-left: 4px solid var(--primary-pink);">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.8rem;">
                                <strong style="color: var(--dark-pink);">Updated on ${date}</strong>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem;">
                                ${history.changes.age ? `
                                    <div>
                                        <small style="color: var(--neutral-gray); display: block;">Age</small>
                                        <div><span style="color: var(--error-red);">${history.changes.age.old}</span> → <span style="color: var(--success-green);">${history.changes.age.new}</span> months</div>
                                    </div>
                                ` : ''}
                                ${history.changes.weight ? `
                                    <div>
                                        <small style="color: var(--neutral-gray); display: block;">Weight</small>
                                        <div><span style="color: var(--error-red);">${history.changes.weight.old}</span> → <span style="color: var(--success-green);">${history.changes.weight.new}</span> kg</div>
                                    </div>
                                ` : ''}
                                ${history.changes.length ? `
                                    <div>
                                        <small style="color: var(--neutral-gray); display: block;">Length</small>
                                        <div><span style="color: var(--error-red);">${history.changes.length.old}</span> → <span style="color: var(--success-green);">${history.changes.length.new}</span> cm</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
                
                historyHTML += '</div>';
                historyContent.innerHTML = historyHTML;
            } catch (error) {
                historyContent.innerHTML = `<p style="text-align: center; color: var(--error-red); padding: 2rem;">Error loading history: ${error.message}</p>`;
            }
        }

        document.getElementById('editPigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentPigToEdit) return;

            const newAge = parseInt(document.getElementById('editPigAge').value);
            const newWeight = parseFloat(document.getElementById('editPigWeight').value);
            const newLength = parseInt(document.getElementById('editPigLength').value);

            try {
                const pigDoc = await firestore.collection('pigs').doc(currentPigToEdit).get();
                const oldData = pigDoc.data();

                const changes = {};
                if (oldData.age !== newAge) {
                    changes.age = { old: oldData.age, new: newAge };
                }
                if (oldData.weight !== newWeight) {
                    changes.weight = { old: oldData.weight, new: newWeight };
                }
                if (oldData.length !== newLength) {
                    changes.length = { old: oldData.length, new: newLength };
                }

                if (Object.keys(changes).length > 0) {
                    await firestore.collection('pigEditHistory').add({
                        pigId: currentPigToEdit,
                        pigTag: oldData.tagNumber,
                        changes: changes,
                        timestamp: Date.now(),
                        userId: currentUser.uid
                    });

                    await firestore.collection('pigs').doc(currentPigToEdit).update({
                        age: newAge,
                        weight: newWeight,
                        length: newLength,
                        lastModified: Date.now()
                    });

                    closeEditModal();
                    loadPigs();
                    showNotification('Pig information updated successfully!', 'success');
                } else {
                    showNotification('No changes were made.', 'info');
                }
            } catch (error) {
                showNotification(`Update failed: ${error.message}`, 'error');
            }
        });

        function openDeleteModal(pigId) {
            currentPigToDelete = pigId;
            document.getElementById('deletePigModal').classList.add('show');
        }

        function closeDeleteModal() {
            currentPigToDelete = null;
            document.getElementById('deletePigModal').classList.remove('show');
        }

        async function confirmDelete() {
            if (!currentPigToDelete) return;

            try {
                await firestore.collection('pigs').doc(currentPigToDelete).delete();
                closeDeleteModal();
                loadPigs();
                showNotification('Pig deleted successfully', 'success');
            } catch (error) {
                showNotification(`Delete failed: ${error.message}`, 'error');
            }
        }

        document.getElementById('sellPigForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!currentPigToSell) return;

            const saleAmount = parseFloat(document.getElementById('sellAmount').value);
            const buyerName = document.getElementById('buyerName').value;

            try {
                await firestore.collection('pigs').doc(currentPigToSell).update({
                    status: 'sold',
                    saleAmount: saleAmount,
                    buyerName: buyerName || 'N/A',
                    saleDate: Date.now()
                });

                closeSellModal();
                loadPigs();
                showNotification(`Pig sold successfully for ₱${saleAmount.toLocaleString()}`, 'success');
            } catch (error) {
                showNotification(`Sale failed: ${error.message}`, 'error');
            }
        });

        // Charts and Statistics
function initializeCharts() {
    destroyAllCharts();

    const tempCtx = document.getElementById('temperatureChart');
    const humidityCtx = document.getElementById('humidityChart');
    const bodyTempCtx = document.getElementById('pigTempChart');

    if (!tempCtx || !humidityCtx || !bodyTempCtx) {
        console.log('Chart canvases not found');
        return;
    }

    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            },
            x: {
                grid: {
                    color: 'rgba(0, 0, 0, 0.05)'
                }
            }
        },
        plugins: {
            legend: {
                position: 'top',
                labels: {
                    font: {
                        family: 'Inter',
                        weight: '600'
                    }
                }
            }
        }
    };

    chartInstances.temperature = new Chart(tempCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Temperature (°C)',
                data: [],
                borderColor: '#E91E63',
                backgroundColor: 'rgba(233, 30, 99, 0.1)',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: '#E91E63'
            }]
        },
        options: chartOptions
    });

    chartInstances.humidity = new Chart(humidityCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Humidity (%)',
                data: [],
                borderColor: '#03A9F4',
                backgroundColor: 'rgba(3, 169, 244, 0.1)',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: '#03A9F4'
            }]
        },
        options: chartOptions
    });

    chartInstances.bodyTemp = new Chart(bodyTempCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Pig Body Temperature (°C)',
                data: [],
                borderColor: '#FF4081',
                backgroundColor: 'rgba(255, 64, 129, 0.1)',
                tension: 0.4,
                borderWidth: 3,
                pointRadius: 4,
                pointBackgroundColor: '#FF4081'
            }]
        },
        options: chartOptions
    });
    
    // Load initial data
    updateCharts();
}

async function updateCharts() {
    if (!currentUser) return;
    
    if (!chartInstances.temperature || !chartInstances.humidity || !chartInstances.bodyTemp) {
        console.log('Charts not initialized');
        return;
    }

    const filter = document.getElementById('dataFilter').value;
    const customDate = document.getElementById('customDate').value;

    try {
        let startTime, endTime;
        const now = Date.now();

        // Calculate time range based on filter
        if (customDate) {
            // If custom date is selected, get data for that entire day
            const selectedDate = new Date(customDate);
            startTime = selectedDate.setHours(0, 0, 0, 0);
            endTime = selectedDate.setHours(23, 59, 59, 999);
        } else {
            // Use filter dropdown
            switch(filter) {
                case '24h':
                    startTime = now - (24 * 60 * 60 * 1000); // 24 hours ago
                    break;
                case '7d':
                    startTime = now - (7 * 24 * 60 * 60 * 1000); // 7 days ago
                    break;
                case '30d':
                    startTime = now - (30 * 24 * 60 * 60 * 1000); // 30 days ago
                    break;
                default:
                    startTime = now - (24 * 60 * 60 * 1000);
            }
            endTime = now;
        }

        // Fetch sensor data from Firebase
        const sensorRef = database.ref(`sensorData/${currentUser.uid}`);
        const snapshot = await sensorRef
            .orderByChild('timestamp')
            .startAt(startTime)
            .endAt(endTime)
            .once('value');

        const sensorData = [];
        snapshot.forEach(child => {
            sensorData.push(child.val());
        });

        // Sort by timestamp
        sensorData.sort((a, b) => a.timestamp - b.timestamp);

        if (sensorData.length === 0) {
            showNotification('No sensor data available for the selected period', 'info');
            
            // Clear charts
            chartInstances.temperature.data.labels = [];
            chartInstances.temperature.data.datasets[0].data = [];
            chartInstances.temperature.update();

            chartInstances.humidity.data.labels = [];
            chartInstances.humidity.data.datasets[0].data = [];
            chartInstances.humidity.update();

            chartInstances.bodyTemp.data.labels = [];
            chartInstances.bodyTemp.data.datasets[0].data = [];
            chartInstances.bodyTemp.update();
            
            return;
        }

        // Determine data point limit based on time range
        let maxDataPoints;
        const timeRangeHours = (endTime - startTime) / (60 * 60 * 1000);
        
        if (timeRangeHours <= 24) {
            maxDataPoints = 48; // Show more detail for 24h
        } else if (timeRangeHours <= 168) { // 7 days
            maxDataPoints = 84; // ~12 points per day
        } else {
            maxDataPoints = 60; // ~2 points per day for 30 days
        }

        // Sample data if too many points
        let sampledData = sensorData;
        if (sensorData.length > maxDataPoints) {
            const step = Math.floor(sensorData.length / maxDataPoints);
            sampledData = sensorData.filter((_, index) => index % step === 0);
        }

        // Prepare chart data
        const labels = [];
        const tempData = [];
        const humidityData = [];
        const pigTempData = [];

        sampledData.forEach(data => {
            const date = new Date(data.timestamp);
            
            // Format label based on time range
            let label;
            if (timeRangeHours <= 24) {
                // Show time for 24h view
                label = date.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                // Show date and time for longer ranges
                label = date.toLocaleString('en-US', { 
                    month: 'short', 
                    day: 'numeric',
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            }
            
            labels.push(label);
            tempData.push(parseFloat(data.temperature) || 0);
            humidityData.push(parseFloat(data.humidity) || 0);
            pigTempData.push(parseFloat(data.pigBodyTemp) || 0);
        });

        // Update charts
        chartInstances.temperature.data.labels = labels;
        chartInstances.temperature.data.datasets[0].data = tempData;
        chartInstances.temperature.update();

        chartInstances.humidity.data.labels = labels;
        chartInstances.humidity.data.datasets[0].data = humidityData;
        chartInstances.humidity.update();

        chartInstances.bodyTemp.data.labels = labels;
        chartInstances.bodyTemp.data.datasets[0].data = pigTempData;
        chartInstances.bodyTemp.update();

        showNotification(`Charts updated with ${sampledData.length} data points`, 'success');

    } catch (error) {
        console.error('Error updating charts:', error);
        showNotification(`Failed to update charts: ${error.message}`, 'error');
    }
}

// Auto-refresh charts every 30 seconds when on statistics page
let chartRefreshInterval;

function startChartAutoRefresh() {
    stopChartAutoRefresh();
    chartRefreshInterval = setInterval(() => {
        const statsPage = document.getElementById('statisticsPage');
        if (statsPage && statsPage.classList.contains('active')) {
            updateCharts();
        }
    }, 30000); // Refresh every 30 seconds
}

function stopChartAutoRefresh() {
    if (chartRefreshInterval) {
        clearInterval(chartRefreshInterval);
        chartRefreshInterval = null;
    }
}

        // Pig Comparison Function
async function updateComparison() {
    const pig1Id = document.getElementById('pig1Select').value;
    const pig2Id = document.getElementById('pig2Select').value;
    
    const comparisonSummary = document.getElementById('comparisonSummary');
    const comparisonChartContainer = document.getElementById('comparisonChartContainer');
    const comparisonChartsGrid = document.getElementById('comparisonChartsGrid');
    
    if (!pig1Id || !pig2Id) {
        showNotification('Please select two pigs to compare', 'warning');
        comparisonSummary.style.display = 'none';
        comparisonChartsGrid.style.display = 'none';
        comparisonChartContainer.innerHTML = `
            <p style="text-align: center; color: var(--neutral-gray); padding: 3rem;">
                <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; display: block; opacity: 0.3;"></i>
                Select two pigs to compare their growth history
            </p>
        `;
        return;
    }
    
    if (pig1Id === pig2Id) {
        showNotification('Please select two different pigs', 'error');
        return;
    }
    
    try {
        // Get pig data
        const pig1Doc = await firestore.collection('pigs').doc(pig1Id).get();
        const pig2Doc = await firestore.collection('pigs').doc(pig2Id).get();
        
        if (!pig1Doc.exists || !pig2Doc.exists) {
            showNotification('One or both pigs not found', 'error');
            return;
        }
        
        const pig1 = pig1Doc.data();
        const pig2 = pig2Doc.data();
        
        // Get edit history for both pigs
        const pig1History = await firestore.collection('pigEditHistory')
            .where('pigId', '==', pig1Id)
            .orderBy('timestamp', 'asc')
            .get();
            
        const pig2History = await firestore.collection('pigEditHistory')
            .where('pigId', '==', pig2Id)
            .orderBy('timestamp', 'asc')
            .get();
        
        // Build history arrays
        const pig1Data = {
            ages: [pig1.age],
            weights: [pig1.weight],
            lengths: [pig1.length],
            dates: [new Date(pig1.registrationDate).toLocaleDateString()]
        };
        
        const pig2Data = {
            ages: [pig2.age],
            weights: [pig2.weight],
            lengths: [pig2.length],
            dates: [new Date(pig2.registrationDate).toLocaleDateString()]
        };
        
        // Add historical data
        pig1History.forEach(doc => {
            const history = doc.data();
            if (history.changes.age) pig1Data.ages.push(history.changes.age.new);
            if (history.changes.weight) pig1Data.weights.push(history.changes.weight.new);
            if (history.changes.length) pig1Data.lengths.push(history.changes.length.new);
            pig1Data.dates.push(new Date(history.timestamp).toLocaleDateString());
        });
        
        pig2History.forEach(doc => {
            const history = doc.data();
            if (history.changes.age) pig2Data.ages.push(history.changes.age.new);
            if (history.changes.weight) pig2Data.weights.push(history.changes.weight.new);
            if (history.changes.length) pig2Data.lengths.push(history.changes.length.new);
            pig2Data.dates.push(new Date(history.timestamp).toLocaleDateString());
        });
        
        // Display summary
        const summaryContent = document.getElementById('summaryContent');
        summaryContent.innerHTML = `
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <strong style="color: var(--primary-pink); font-size: 1.1rem;">${pig1.tagNumber}</strong>
                    <div style="margin-top: 0.5rem;">
                        <div><strong>Breed:</strong> ${pig1.breed}</div>
                        <div><strong>Current Age:</strong> ${pig1.age} months</div>
                        <div><strong>Current Weight:</strong> ${pig1.weight} kg</div>
                        <div><strong>Current Length:</strong> ${pig1.length} cm</div>
                    </div>
                </div>
                <div>
                    <strong style="color: var(--accent-pink); font-size: 1.1rem;">${pig2.tagNumber}</strong>
                    <div style="margin-top: 0.5rem;">
                        <div><strong>Breed:</strong> ${pig2.breed}</div>
                        <div><strong>Current Age:</strong> ${pig2.age} months</div>
                        <div><strong>Current Weight:</strong> ${pig2.weight} kg</div>
                        <div><strong>Current Length:</strong> ${pig2.length} cm</div>
                    </div>
                </div>
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid var(--light-pink);">
    <strong style="color: var(--dark-pink);">Swine Health Form – Physical Comparison:</strong>
    <div style="margin-top: 0.5rem;">

        <!-- Age Comparison -->
        ${pig1.age > pig2.age ? 
            `<div>• ${pig1.tagNumber} is older by ${pig1.age - pig2.age} months</div>` :
            pig1.age < pig2.age ?
            `<div>• ${pig2.tagNumber} is older by ${pig2.age - pig1.age} months</div>` :
            `<div>• Both pigs are the same age</div>`
        }

        <!-- Weight Comparison -->
        ${pig1.weight > pig2.weight ? 
            `<div>• ${pig1.tagNumber} is heavier by ${(pig1.weight - pig2.weight).toFixed(1)} kg</div>` :
            `<div>• ${pig2.tagNumber} is heavier by ${(pig2.weight - pig1.weight).toFixed(1)} kg</div>`
        }

        <!-- Length Comparison -->
        ${pig1.length > pig2.length ? 
            `<div>• ${pig1.tagNumber} is longer by ${pig1.length - pig2.length} cm</div>` :
            `<div>• ${pig2.tagNumber} is longer by ${pig2.length - pig1.length} cm</div>`
        }

        <!-- Pig Category Determination -->
        <div style="margin-top: 0.5rem;">
            <strong>Category & Health Status:</strong>

            <!-- Pig 1 Category -->
            <div>
                • ${pig1.tagNumber} is 
                ${
                    pig1.age <= 2 ? "a Piglet" :
                    pig1.age <= 3 ? "a Weaner" :
                    pig1.age <= 5 ? "a Grower" :
                    pig1.age <= 6 ? "a Finisher" :
                    "an Adult Breeding Pig"
                }
                —
                ${
                    pig1.age <= 2 ? (pig1.weight >= 3 && pig1.weight <= 12 ? "Healthy" : "Unhealthy/Underweight") :
                    pig1.age <= 3 ? (pig1.weight >= 12 && pig1.weight <= 30 ? "Healthy" : "Unhealthy/Underweight") :
                    pig1.age <= 5 ? (pig1.weight >= 25 && pig1.weight <= 70 ? "Healthy" : "Unhealthy/Underweight") :
                    pig1.age <= 6 ? (pig1.weight >= 70 && pig1.weight <= 130 ? "Healthy" : "Unhealthy/Underweight") :
                    (pig1.weight >= 150 && pig1.weight <= 300 ? "Healthy" : "Unhealthy/Underweight")
                }
            </div>

            <!-- Pig 2 Category -->
            <div>
                • ${pig2.tagNumber} is 
                ${
                    pig2.age <= 2 ? "a Piglet" :
                    pig2.age <= 3 ? "a Weaner" :
                    pig2.age <= 5 ? "a Grower" :
                    pig2.age <= 6 ? "a Finisher" :
                    "an Adult Breeding Pig"
                }
                —
                ${
                    pig2.age <= 2 ? (pig2.weight >= 3 && pig2.weight <= 12 ? "Healthy" : "Unhealthy/Underweight") :
                    pig2.age <= 3 ? (pig2.weight >= 12 && pig2.weight <= 30 ? "Healthy" : "Unhealthy/Underweight") :
                    pig2.age <= 5 ? (pig2.weight >= 25 && pig2.weight <= 70 ? "Healthy" : "Unhealthy/Underweight") :
                    pig2.age <= 6 ? (pig2.weight >= 70 && pig2.weight <= 130 ? "Healthy" : "Unhealthy/Underweight") :
                    (pig2.weight >= 150 && pig2.weight <= 300 ? "Healthy" : "Unhealthy/Underweight")
                }
            </div>
        </div>

    </div>
</div>

        `;
        
        comparisonSummary.style.display = 'block';
        comparisonChartContainer.style.display = 'none';
        comparisonChartsGrid.style.display = 'grid';
        
        // Destroy existing comparison charts
        ['ageComparisonChart', 'weightComparisonChart', 'lengthComparisonChart'].forEach(chartId => {
            destroyChart(chartId);
        });
        
        // Create comparison charts
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                },
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        font: {
                            family: 'Inter',
                            weight: '600'
                        }
                    }
                }
            }
        };
        
        // Age Comparison Chart
        chartInstances.ageComparisonChart = new Chart(document.getElementById('ageComparisonChart'), {
            type: 'line',
            data: {
                labels: pig1Data.dates.length >= pig2Data.dates.length ? pig1Data.dates : pig2Data.dates,
                datasets: [
                    {
                        label: pig1.tagNumber,
                        data: pig1Data.ages,
                        borderColor: '#E91E63',
                        backgroundColor: 'rgba(233, 30, 99, 0.1)',
                        tension: 0.4,
                        borderWidth: 3
                    },
                    {
                        label: pig2.tagNumber,
                        data: pig2Data.ages,
                        borderColor: '#FF4081',
                        backgroundColor: 'rgba(255, 64, 129, 0.1)',
                        tension: 0.4,
                        borderWidth: 3
                    }
                ]
            },
            options: chartOptions
        });
        
        // Weight Comparison Chart
        chartInstances.weightComparisonChart = new Chart(document.getElementById('weightComparisonChart'), {
            type: 'line',
            data: {
                labels: pig1Data.dates.length >= pig2Data.dates.length ? pig1Data.dates : pig2Data.dates,
                datasets: [
                    {
                        label: pig1.tagNumber,
                        data: pig1Data.weights,
                        borderColor: '#2196F3',
                        backgroundColor: 'rgba(33, 150, 243, 0.1)',
                        tension: 0.4,
                        borderWidth: 3
                    },
                    {
                        label: pig2.tagNumber,
                        data: pig2Data.weights,
                        borderColor: '#03A9F4',
                        backgroundColor: 'rgba(3, 169, 244, 0.1)',
                        tension: 0.4,
                        borderWidth: 3
                    }
                ]
            },
            options: chartOptions
        });
        
        // Length Comparison Chart
        chartInstances.lengthComparisonChart = new Chart(document.getElementById('lengthComparisonChart'), {
            type: 'line',
            data: {
                labels: pig1Data.dates.length >= pig2Data.dates.length ? pig1Data.dates : pig2Data.dates,
                datasets: [
                    {
                        label: pig1.tagNumber,
                        data: pig1Data.lengths,
                        borderColor: '#9C27B0',
                        backgroundColor: 'rgba(156, 39, 176, 0.1)',
                        tension: 0.4,
                        borderWidth: 3
                    },
                    {
                        label: pig2.tagNumber,
                        data: pig2Data.lengths,
                        borderColor: '#7B1FA2',
                        backgroundColor: 'rgba(123, 31, 162, 0.1)',
                        tension: 0.4,
                        borderWidth: 3
                    }
                ]
            },
            options: chartOptions
        });
        
        showNotification('Comparison charts generated successfully!', 'success');
        
    } catch (error) {
        showNotification(`Comparison failed: ${error.message}`, 'error');
        console.error('Comparison error:', error);
    }
}

// Single Pig Growth Analysis Function
async function showPigGrowthAnalysis(pigId) {
    if (!pigId) {
        showNotification('Please select a pig to analyze', 'warning');
        return;
    }
    
    try {
        // Get pig data
        const pigDoc = await firestore.collection('pigs').doc(pigId).get();
        
        if (!pigDoc.exists) {
            showNotification('Pig not found', 'error');
            return;
        }
        
        const pig = pigDoc.data();
        
        // Get edit history
        const historySnapshot = await firestore.collection('pigEditHistory')
            .where('pigId', '==', pigId)
            .orderBy('timestamp', 'asc')
            .get();
        
        // Build historical data arrays
        const dates = [new Date(pig.registrationDate).toLocaleDateString()];
        let weights = [];
        let lengths = [];
        let ages = [];
        
        // Track changes
        const weightChanges = [];
        const lengthChanges = [];
        
        // IMPORTANT: Find the initial values from the first edit history
        // If there's history, the "old" value of the first change is the initial value
        let initialWeight = pig.weight;
        let initialLength = pig.length;
        let initialAge = pig.age;
        
        if (!historySnapshot.empty) {
            const firstEdit = historySnapshot.docs[0].data();
            if (firstEdit.changes.weight) {
                initialWeight = firstEdit.changes.weight.old;
            }
            if (firstEdit.changes.length) {
                initialLength = firstEdit.changes.length.old;
            }
            if (firstEdit.changes.age) {
                initialAge = firstEdit.changes.age.old;
            }
        }
        
        // Start with initial values
        weights.push(initialWeight);
        lengths.push(initialLength);
        ages.push(initialAge);
        
        historySnapshot.forEach(doc => {
            const history = doc.data();
            const date = new Date(history.timestamp).toLocaleDateString();
            dates.push(date);
            
            if (history.changes.weight) {
                weights.push(history.changes.weight.new);
                weightChanges.push({
                    date: date,
                    old: history.changes.weight.old,
                    new: history.changes.weight.new,
                    change: (history.changes.weight.new - history.changes.weight.old).toFixed(1)
                });
            } else {
                weights.push(weights[weights.length - 1]); // Carry forward last value
            }
            
            if (history.changes.length) {
                lengths.push(history.changes.length.new);
                lengthChanges.push({
                    date: date,
                    old: history.changes.length.old,
                    new: history.changes.length.new,
                    change: (history.changes.length.new - history.changes.length.old)
                });
            } else {
                lengths.push(lengths[lengths.length - 1]); // Carry forward last value
            }
            
            if (history.changes.age) {
                ages.push(history.changes.age.new);
            } else {
                ages.push(ages[ages.length - 1]); // Carry forward last value
            }
        });
        
        // Calculate statistics using initial values vs current values
        const currentWeight = weights[weights.length - 1];
        const currentLength = lengths[lengths.length - 1];
        const totalWeightGain = currentWeight - initialWeight;
        const totalLengthGain = currentLength - initialLength;
        
        const avgWeightPerUpdate = weightChanges.length > 0 
            ? (weightChanges.reduce((sum, c) => sum + parseFloat(c.change), 0) / weightChanges.length).toFixed(2)
            : 0;
        const avgLengthPerUpdate = lengthChanges.length > 0 
            ? (lengthChanges.reduce((sum, c) => sum + parseFloat(c.change), 0) / lengthChanges.length).toFixed(1)
            : 0;
        
        // Create modal content
        const modalContent = `
            <div style="font-family: 'Inter', sans-serif;">
                <div style="text-align: center; margin-bottom: 2rem; padding: 1.5rem; background: linear-gradient(135deg, rgba(233, 30, 99, 0.1), rgba(240, 98, 146, 0.1)); border-radius: 12px;">
                    <h2 style="color: var(--primary-pink); margin-bottom: 0.5rem; font-size: 1.8rem;">Growth Analysis</h2>
                    <h3 style="color: var(--dark-pink); font-size: 1.3rem;">${pig.tagNumber} - ${pig.breed}</h3>
                </div>
                
                <!-- Initial vs Current Comparison -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="background: rgba(158, 158, 158, 0.08); padding: 1rem; border-radius: 12px; border: 2px dashed #9E9E9E;">
                        <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem; text-align: center;">Initial Values (Registration)</div>
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="font-size: 0.7rem; color: #999;">Weight</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #666;">${initialWeight} kg</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; color: #999;">Length</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #666;">${initialLength} cm</div>
                            </div>
                        </div>
                    </div>
                    <div style="background: rgba(76, 175, 80, 0.08); padding: 1rem; border-radius: 12px; border: 2px solid #4CAF50;">
                        <div style="font-size: 0.75rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem; text-align: center;">Current Values</div>
                        <div style="display: flex; justify-content: space-around; text-align: center;">
                            <div>
                                <div style="font-size: 0.7rem; color: #999;">Weight</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #4CAF50;">${currentWeight} kg</div>
                            </div>
                            <div>
                                <div style="font-size: 0.7rem; color: #999;">Length</div>
                                <div style="font-size: 1.3rem; font-weight: 700; color: #4CAF50;">${currentLength} cm</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Summary Statistics -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: rgba(33, 150, 243, 0.08); padding: 1.2rem; border-radius: 12px; border-left: 4px solid #2196F3;">
                        <div style="font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.3rem;">Total Weight Gain</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: ${totalWeightGain >= 0 ? '#2196F3' : '#F44336'};">
                            ${totalWeightGain >= 0 ? '+' : ''}${totalWeightGain.toFixed(1)} <span style="font-size: 1rem;">kg</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.3rem;">
                            Avg per update: ${avgWeightPerUpdate} kg
                            ${weightChanges.length > 0 ? `<br>Total updates: ${weightChanges.length}` : ''}
                        </div>
                    </div>
                    <div style="background: rgba(156, 39, 176, 0.08); padding: 1.2rem; border-radius: 12px; border-left: 4px solid #9C27B0;">
                        <div style="font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.3rem;">Total Length Gain</div>
                        <div style="font-size: 1.8rem; font-weight: 800; color: ${totalLengthGain >= 0 ? '#9C27B0' : '#F44336'};">
                            ${totalLengthGain >= 0 ? '+' : ''}${totalLengthGain} <span style="font-size: 1rem;">cm</span>
                        </div>
                        <div style="font-size: 0.75rem; color: #666; margin-top: 0.3rem;">
                            Avg per update: ${avgLengthPerUpdate} cm
                            ${lengthChanges.length > 0 ? `<br>Total updates: ${lengthChanges.length}` : ''}
                        </div>
                    </div>
                </div>
                
                <!-- Growth Charts -->
                <div style="margin-bottom: 2rem;">
                    <h4 style="color: var(--dark-pink); margin-bottom: 1rem; text-align: center;">Weight & Length Growth Over Time</h4>
                    <canvas id="singlePigGrowthChart" style="max-height: 350px;"></canvas>
                </div>
                
                <!-- Change Details -->
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
                    <!-- Weight Changes -->
                    <div>
                        <h4 style="color: #2196F3; margin-bottom: 1rem; font-size: 1.1rem;">
                            <i class="fas fa-weight"></i> Weight Changes (${weightChanges.length} updates)
                        </h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${weightChanges.length > 0 ? weightChanges.map(change => `
                                <div style="background: ${parseFloat(change.change) > 0 ? 'rgba(76, 175, 80, 0.08)' : 'rgba(244, 67, 54, 0.08)'}; 
                                            padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; 
                                            border-left: 3px solid ${parseFloat(change.change) > 0 ? '#4CAF50' : '#F44336'};">
                                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.3rem;">${change.date}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #999;">${change.old} kg</span>
                                            <i class="fas fa-arrow-right" style="margin: 0 0.5rem; color: #666;"></i>
                                            <span style="font-weight: 700; color: #2196F3;">${change.new} kg</span>
                                        </div>
                                        <div style="font-weight: 700; color: ${parseFloat(change.change) > 0 ? '#4CAF50' : '#F44336'};">
                                            ${parseFloat(change.change) > 0 ? '+' : ''}${change.change} kg
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<div style="text-align: center; color: #999; padding: 2rem;">No weight changes recorded</div>'}
                        </div>
                    </div>
                    
                    <!-- Length Changes -->
                    <div>
                        <h4 style="color: #9C27B0; margin-bottom: 1rem; font-size: 1.1rem;">
                            <i class="fas fa-ruler-horizontal"></i> Length Changes (${lengthChanges.length} updates)
                        </h4>
                        <div style="max-height: 300px; overflow-y: auto;">
                            ${lengthChanges.length > 0 ? lengthChanges.map(change => `
                                <div style="background: ${parseFloat(change.change) > 0 ? 'rgba(76, 175, 80, 0.08)' : 'rgba(244, 67, 54, 0.08)'}; 
                                            padding: 0.8rem; border-radius: 8px; margin-bottom: 0.5rem; 
                                            border-left: 3px solid ${parseFloat(change.change) > 0 ? '#4CAF50' : '#F44336'};">
                                    <div style="font-size: 0.75rem; color: #666; margin-bottom: 0.3rem;">${change.date}</div>
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <span style="color: #999;">${change.old} cm</span>
                                            <i class="fas fa-arrow-right" style="margin: 0 0.5rem; color: #666;"></i>
                                            <span style="font-weight: 700; color: #9C27B0;">${change.new} cm</span>
                                        </div>
                                        <div style="font-weight: 700; color: ${parseFloat(change.change) > 0 ? '#4CAF50' : '#F44336'};">
                                            ${parseFloat(change.change) > 0 ? '+' : ''}${change.change} cm
                                        </div>
                                    </div>
                                </div>
                            `).join('') : '<div style="text-align: center; color: #999; padding: 2rem;">No length changes recorded</div>'}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Show in modal
        const modal = document.getElementById('historyModal');
        const historyContent = document.getElementById('historyContent');
        historyContent.innerHTML = modalContent;
        modal.classList.add('show');
        
        // Create combined growth chart
        setTimeout(() => {
            const ctx = document.getElementById('singlePigGrowthChart');
            if (ctx) {
                destroyChart('singlePigGrowthChart');
                
                chartInstances.singlePigGrowthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dates,
                        datasets: [
                            {
                                label: 'Weight (kg)',
                                data: weights,
                                borderColor: '#2196F3',
                                backgroundColor: 'rgba(33, 150, 243, 0.1)',
                                tension: 0.4,
                                borderWidth: 3,
                                yAxisID: 'y',
                                pointRadius: 5,
                                pointHoverRadius: 7
                            },
                            {
                                label: 'Length (cm)',
                                data: lengths,
                                borderColor: '#9C27B0',
                                backgroundColor: 'rgba(156, 39, 176, 0.1)',
                                tension: 0.4,
                                borderWidth: 3,
                                yAxisID: 'y1',
                                pointRadius: 5,
                                pointHoverRadius: 7
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Weight (kg)',
                                    color: '#2196F3',
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Length (cm)',
                                    color: '#9C27B0',
                                    font: {
                                        weight: 'bold'
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false,
                                }
                            },
                            x: {
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: {
                                        family: 'Inter',
                                        weight: '600'
                                    }
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += context.parsed.y;
                                            label += context.datasetIndex === 0 ? ' kg' : ' cm';
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        }, 100);
        
    } catch (error) {
        showNotification(`Growth analysis failed: ${error.message}`, 'error');
        console.error('Growth analysis error:', error);
    }
}

        // Notifications
        function addNotification(title, message, type) {
            const notificationsList = document.getElementById('notificationsList');
            
            const iconMap = {
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'success': 'fa-check-circle',
                'info': 'fa-info-circle'
            };

            const notificationEl = document.createElement('div');
            notificationEl.className = `alert alert-${type}`;
            notificationEl.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: start;">
                    <div style="flex: 1;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                            <i class="fas ${iconMap[type] || 'fa-bell'}" style="font-size: 1.3rem;"></i>
                            <strong style="font-size: 1.05rem;">${title}</strong>
                        </div>
                        <div style="margin-left: 2.05rem; line-height: 1.5;">${message}</div>
                        <small style="opacity: 0.7; margin-left: 2.05rem; display: block; margin-top: 0.5rem;">
                            <i class="fas fa-clock" style="margin-right: 0.3rem;"></i>${new Date().toLocaleString()}
                        </small>
                    </div>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; cursor: pointer; padding: 0.5rem; margin-left: 1rem; opacity: 0.6; transition: opacity 0.2s;">
                        <i class="fas fa-times" style="font-size: 1.2rem;"></i>
                    </button>
                </div>
            `;
            
            notificationsList.insertBefore(notificationEl, notificationsList.firstChild);

            if (currentUser) {
                firestore.collection('notifications').add({
                    title: title,
                    message: message,
                    type: type,
                    timestamp: Date.now(),
                    userId: currentUser.uid,
                    read: false
                });
            }
        }

        function showNotification(message, type) {
            const toast = document.getElementById('notificationToast');
            const messageEl = document.getElementById('notificationMessage');
            
            messageEl.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

// Reports Generation
function generateReport() {
    const startDate = document.getElementById('reportStartDate').value;
    const endDate = document.getElementById('reportEndDate').value;

    if (!startDate || !endDate) {
        showNotification('Please select both start and end dates', 'error');
        return;
    }
    
    // Validate date range
    const start = new Date(startDate);
    const end = new Date(endDate);
    
    if (start > end) {
        showNotification('Start date cannot be after end date', 'error');
        return;
    }

    generatePDFReport(startDate, endDate);
}

async function generatePDFReport(startDate, endDate) {
    try {
        showNotification('Generating report, please wait...', 'info');
        
        // Convert dates to timestamps
        const startTimestamp = new Date(startDate).setHours(0, 0, 0, 0);
        const endTimestamp = new Date(endDate).setHours(23, 59, 59, 999);

        // Fetch pigs data
        const pigsSnapshot = await firestore.collection('pigs')
            .where('userId', '==', currentUser.uid)
            .get();

        // Fetch edit history within date range
        const historySnapshot = await firestore.collection('pigEditHistory')
            .where('userId', '==', currentUser.uid)
            .where('timestamp', '>=', startTimestamp)
            .where('timestamp', '<=', endTimestamp)
            .orderBy('timestamp', 'desc')
            .get();

        // Fetch sensor data within date range
        const sensorRef = database.ref(`sensorData/${currentUser.uid}`);
        const sensorSnapshot = await sensorRef
            .orderByChild('timestamp')
            .startAt(startTimestamp)
            .endAt(endTimestamp)
            .once('value');

        const sensorData = [];
        sensorSnapshot.forEach(child => {
            sensorData.push(child.val());
        });

        // Calculate average temperature and humidity from filtered data
        const avgTemp = sensorData.length > 0 
            ? (sensorData.reduce((sum, d) => sum + (parseFloat(d.temperature) || 0), 0) / sensorData.length).toFixed(2)
            : 0;
        const avgHumidity = sensorData.length > 0 
            ? (sensorData.reduce((sum, d) => sum + (parseFloat(d.humidity) || 0), 0) / sensorData.length).toFixed(2)
            : 0;
        const avgPigTemp = sensorData.length > 0 
            ? (sensorData.reduce((sum, d) => sum + (parseFloat(d.pigBodyTemp) || 0), 0) / sensorData.length).toFixed(2)
            : 0;

        // Temperature status
        let tempStatus = 'Normal';
        let tempColor = '#4CAF50';
        if (avgTemp < 30) {
            tempStatus = 'Abnormal - Cold';
            tempColor = '#2196F3';
        } else if (avgTemp > 34) {
            tempStatus = 'Abnormal - Hot';
            tempColor = '#F44336';
        }

        // Humidity status
        let humidityStatus = 'Normal';
        let humidityColor = '#4CAF50';
        if (avgHumidity < 40) {
            humidityStatus = 'Abnormal - Too Dry';
            humidityColor = '#FF9800';
        } else if (avgHumidity > 75) {
            humidityStatus = 'Abnormal - Too Humid';
            humidityColor = '#F44336';
        }

        // Pig body temperature status
        let pigTempStatus = 'Normal';
        let pigTempColor = '#4CAF50';
        if (avgPigTemp < 38) {
            pigTempStatus = 'Below Normal';
            pigTempColor = '#2196F3';
        } else if (avgPigTemp > 40) {
            pigTempStatus = 'Above Normal - Possible Fever';
            pigTempColor = '#F44336';
        }

        let totalPigs = 0;
        let totalWeight = 0;
        let totalLength = 0;
        let activePigs = 0;
        let soldPigs = 0;
        let totalRevenue = 0;
        const pigsData = [];
        const pigHistoryMap = {};

        pigsSnapshot.forEach(doc => {
            const pig = doc.data();
            pigsData.push({ id: doc.id, ...pig });
            totalPigs++;
            totalWeight += pig.weight || 0;
            totalLength += pig.length || 0;
            if (pig.status === 'active') activePigs++;
            if (pig.status === 'sold') {
                soldPigs++;
                // Check if pig was sold within the date range
                if (pig.saleDate && pig.saleDate >= startTimestamp && pig.saleDate <= endTimestamp) {
                    totalRevenue += pig.saleAmount || 0;
                }
            }
        });

        // Map history to pigs (only history within date range)
        historySnapshot.forEach(doc => {
            const history = doc.data();
            if (!pigHistoryMap[history.pigId]) {
                pigHistoryMap[history.pigId] = [];
            }
            pigHistoryMap[history.pigId].push(history);
        });

        const reportContent = document.getElementById('reportContent');
        reportContent.innerHTML = `
            <div id="pdfContent" style="font-family: 'Inter', Arial, sans-serif; padding: 2rem; background: white;">
                <div style="text-align: center; margin-bottom: 3rem; padding-bottom: 2rem; border-bottom: 3px solid #E91E63;">
                    <div style="background: linear-gradient(135deg, #E91E63, #C2185B); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 1.5rem;">
                        <h1 style="margin-bottom: 0.5rem; font-size: 2.2rem; font-weight: 800;">SwineCare Management Report</h1>
                        <p style="font-size: 1.1rem; opacity: 0.95;">Comprehensive Pig Management Summary</p>
                        <p style="opacity: 0.9; margin-top: 0.5rem;">Period: ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}</p>
                        <p style="opacity: 0.85; margin-top: 0.3rem; font-size: 0.9rem;">Data points collected: ${sensorData.length}</p>
                    </div>
                </div>

                <div style="margin-bottom: 2.5rem;">
                    <h2 style="color: #C2185B; margin-bottom: 1.5rem; font-size: 1.6rem; font-weight: 700; border-left: 4px solid #E91E63; padding-left: 1rem;">
                        Overall Statistics
                    </h2>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div style="background: rgba(233, 30, 99, 0.08); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #E91E63; text-align: center;">
                            <div style="font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem;">Total Pigs</div>
                            <div style="font-size: 2.2rem; font-weight: 800; color: #E91E63;">${totalPigs}</div>
                        </div>
                        <div style="background: rgba(76, 175, 80, 0.08); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #4CAF50; text-align: center;">
                            <div style="font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem;">Active</div>
                            <div style="font-size: 2.2rem; font-weight: 800; color: #4CAF50;">${activePigs}</div>
                        </div>
                        <div style="background: rgba(244, 67, 54, 0.08); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #F44336; text-align: center;">
                            <div style="font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem;">Sold</div>
                            <div style="font-size: 2.2rem; font-weight: 800; color: #F44336;">${soldPigs}</div>
                        </div>
                    </div>
                    ${totalRevenue > 0 ? `
                        <div style="background: rgba(255, 152, 0, 0.08); padding: 1.2rem; border-radius: 12px; border-left: 4px solid #FF9800; text-align: center;">
                            <div style="font-size: 0.85rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.5rem;">Revenue from Sales (${startDate} to ${endDate})</div>
                            <div style="font-size: 2rem; font-weight: 800; color: #FF9800;">₱${totalRevenue.toLocaleString()}</div>
                        </div>
                    ` : ''}
                </div>

                <div style="margin-bottom: 2.5rem;">
                    <h2 style="color: #C2185B; margin-bottom: 1.5rem; font-size: 1.6rem; font-weight: 700; border-left: 4px solid #E91E63; padding-left: 1rem;">
                        Environmental Conditions (${startDate} to ${endDate})
                    </h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
                        <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 2px solid #E8E8E8;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: rgba(233, 30, 99, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-thermometer-half" style="color: #E91E63; font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #666; font-weight: 700; text-transform: uppercase;">Ambient Temp</div>
                                    <div style="font-size: 1.8rem; font-weight: 800; color: ${tempColor};">${avgTemp}°C</div>
                                </div>
                            </div>
                            <div style="padding: 0.8rem; background: ${tempColor}15; border-left: 4px solid ${tempColor}; border-radius: 8px;">
                                <strong style="color: ${tempColor};">Status: ${tempStatus}</strong>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
                                    ${avgTemp >= 30 && avgTemp <= 34 ? '✓ Within normal range (30-34°C)' : 
                                      avgTemp < 30 ? '⚠ Below normal range' : 
                                      '⚠ Above normal range'}
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 2px solid #E8E8E8;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: rgba(3, 169, 244, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-tint" style="color: #03A9F4; font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #666; font-weight: 700; text-transform: uppercase;">Humidity</div>
                                    <div style="font-size: 1.8rem; font-weight: 800; color: ${humidityColor};">${avgHumidity}%</div>
                                </div>
                            </div>
                            <div style="padding: 0.8rem; background: ${humidityColor}15; border-left: 4px solid ${humidityColor}; border-radius: 8px;">
                                <strong style="color: ${humidityColor};">Status: ${humidityStatus}</strong>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
                                    ${avgHumidity >= 50 && avgHumidity <= 70 ? '✓ Within normal range (50-70%)' : 
                                      avgHumidity < 40 ? '⚠ Too dry' : 
                                      avgHumidity > 75 ? '⚠ Too humid' :
                                      '⚠ Slightly outside range'}
                                </div>
                            </div>
                        </div>

                        <div style="background: white; padding: 1.5rem; border-radius: 12px; border: 2px solid #E8E8E8;">
                            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
                                <div style="width: 50px; height: 50px; background: rgba(255, 64, 129, 0.1); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-heartbeat" style="color: #FF4081; font-size: 1.5rem;"></i>
                                </div>
                                <div>
                                    <div style="font-size: 0.85rem; color: #666; font-weight: 700; text-transform: uppercase;">Pig Body Temp</div>
                                    <div style="font-size: 1.8rem; font-weight: 800; color: ${pigTempColor};">${avgPigTemp}°C</div>
                                </div>
                            </div>
                            <div style="padding: 0.8rem; background: ${pigTempColor}15; border-left: 4px solid ${pigTempColor}; border-radius: 8px;">
                                <strong style="color: ${pigTempColor};">Status: ${pigTempStatus}</strong>
                                <div style="font-size: 0.85rem; color: #666; margin-top: 0.3rem;">
                                    ${avgPigTemp >= 38 && avgPigTemp <= 40 ? '✓ Within normal range (38-40°C)' : 
                                      avgPigTemp < 38 ? '⚠ Below normal' : 
                                      '⚠ Above normal - Check health'}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="margin-bottom: 2.5rem;">
                    <h2 style="color: #C2185B; margin-bottom: 1.5rem; font-size: 1.6rem; font-weight: 700; border-left: 4px solid #E91E63; padding-left: 1rem;">
                        Pig Details & Changes (${historySnapshot.size} updates in period)
                    </h2>
                    
                    ${pigsData.map(pig => {
                        const history = pigHistoryMap[pig.id] || [];
                        return `
                            <div style="margin-bottom: 2rem; background: white; padding: 1.5rem; border-radius: 12px; border: 2px solid #E8E8E8; page-break-inside: avoid;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid #FCE4EC;">
                                    <div>
                                        <h3 style="color: #E91E63; margin-bottom: 0.3rem; font-size: 1.3rem;">Pig Tag: ${pig.tagNumber}</h3>
                                        <p style="color: #666; margin: 0;">Breed: ${pig.breed} | Gender: ${pig.gender}</p>
                                    </div>
                                    <span style="padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700; background: ${pig.status === 'active' ? 'rgba(76, 175, 80, 0.12)' : 'rgba(244, 67, 54, 0.12)'}; color: ${pig.status === 'active' ? '#4CAF50' : '#F44336'};">
                                        ${pig.status.toUpperCase()}
                                    </span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                    <div style="background: rgba(233, 30, 99, 0.05); padding: 1rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.3rem;">Current Age</div>
                                        <div style="font-size: 1.5rem; font-weight: 800; color: #E91E63;">${pig.age} <span style="font-size: 0.9rem;">months</span></div>
                                    </div>
                                    <div style="background: rgba(33, 150, 243, 0.05); padding: 1rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.3rem;">Current Weight</div>
                                        <div style="font-size: 1.5rem; font-weight: 800; color: #2196F3;">${pig.weight} <span style="font-size: 0.9rem;">kg</span></div>
                                    </div>
                                    <div style="background: rgba(156, 39, 176, 0.05); padding: 1rem; border-radius: 8px;">
                                        <div style="font-size: 0.8rem; color: #666; text-transform: uppercase; font-weight: 700; margin-bottom: 0.3rem;">Current Length</div>
                                        <div style="font-size: 1.5rem; font-weight: 800; color: #9C27B0;">${pig.length} <span style="font-size: 0.9rem;">cm</span></div>
                                    </div>
                                </div>

                                ${history.length > 0 ? `
                                    <div style="background: #F5F5F5; padding: 1rem; border-radius: 8px;">
                                        <h4 style="color: #C2185B; margin-bottom: 0.8rem; font-size: 1rem;"><i class="fas fa-history"></i> Changes in Report Period (${history.length} updates)</h4>
                                        ${history.map(h => {
                                            const date = new Date(h.timestamp).toLocaleDateString();
                                            return `
                                                <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px;">
                                                    <small style="color: #666; font-weight: 600;">${date}:</small>
                                                    ${h.changes.age ? `<span style="margin-left: 0.5rem;">Age: <span style="color: #F44336;">${h.changes.age.old}</span> → <span style="color: #4CAF50;">${h.changes.age.new}</span> months</span>` : ''}
                                                    ${h.changes.weight ? `<span style="margin-left: 0.5rem;">Weight: <span style="color: #F44336;">${h.changes.weight.old}</span> → <span style="color: #4CAF50;">${h.changes.weight.new}</span> kg</span>` : ''}
                                                    ${h.changes.length ? `<span style="margin-left: 0.5rem;">Length: <span style="color: #F44336;">${h.changes.length.old}</span> → <span style="color: #4CAF50;">${h.changes.length.new}</span> cm</span>` : ''}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : '<div style="background: #F5F5F5; padding: 1rem; border-radius: 8px; text-align: center; color: #666;">No changes recorded in this period.</div>'}
                            </div>
                        `;
                    }).join('')}
                </div>

                <div style="text-align: center; margin-top: 4rem; padding-top: 2rem; border-top: 2px solid #E8E8E8;">
                    <p style="color: #666; font-size: 0.9rem; line-height: 1.8;">
                        <strong style="color: #E91E63;">Generated on:</strong> ${new Date().toLocaleString()}<br>
                        <strong style="color: #E91E63;">Report Period:</strong> ${new Date(startDate).toLocaleDateString()} to ${new Date(endDate).toLocaleDateString()}<br>
                        <strong style="color: #E91E63;">SwineCare</strong> IoT Monitoring System<br>
                        <em style="font-size: 0.85rem;">Professional Swine Health Management Solution</em>
                    </p>
                </div>
            </div>
        `;

        // Generate PDF
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        
        const element = document.getElementById('pdfContent');
        const canvas = await html2canvas(element, {
            scale: 2,
            useCORS: true,
            backgroundColor: '#ffffff',
            logging: false
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210;
        const pageHeight = 295;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;
        
        let position = 0;
        
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        
        const filename = `SwineCare_Report_${startDate}_to_${endDate}.pdf`;
        pdf.save(filename);
        showNotification('PDF report generated successfully!', 'success');

    } catch (error) {
        showNotification(`Report generation failed: ${error.message}`, 'error');
        console.error('Report generation error:', error);
    }
}

// Setup Realtime Listeners
function setupRealtimeListeners() {
    if (!currentUser) return;

    database.ref(`sensorData/${currentUser.uid}`).limitToLast(1).on('child_added', (snapshot) => {
        const data = snapshot.val();
        if (data) {
            document.getElementById('temperature').innerHTML = `${data.temperature}<span class="stat-unit">°C</span>`;
            document.getElementById('humidity').innerHTML = `${data.humidity}<span class="stat-unit">%</span>`;
            document.getElementById('pigBodyTemp').innerHTML = `${data.pigBodyTemp}<span class="stat-unit">°C</span>`;
        }
    });

    firestore.collection('pigs')
        .where('userId', '==', currentUser.uid)
        .onSnapshot((snapshot) => {
            loadPigs();
        });
}

// Check for remembered user on page load
window.addEventListener('load', () => {
    if (localStorage.getItem('rememberMe') === 'true') {
        const savedEmail = localStorage.getItem('userEmail');
        if (savedEmail) {
            document.getElementById('loginEmail').value = savedEmail;
            document.getElementById('rememberMe').checked = true;
        }
    }

    const today = new Date();
    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
    document.getElementById('reportStartDate').value = weekAgo.toISOString().split('T')[0];
    document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
});

// Auth State Observer
auth.onAuthStateChanged((user) => {
    if (user) {
        currentUser = user;
        showMainApp();
        startDataSimulation();
    } else {
        currentUser = null;
        stopDataSimulation();
        document.getElementById('authContainer').style.display = 'flex';
        document.getElementById('appContainer').style.display = 'none';
    }
});

// Initialize charts when statistics page is shown
let chartsInitialized = false;
const originalShowPage = showPage;
showPage = function(pageId) {
    originalShowPage.call(this, pageId);
    if (pageId === 'statistics' && !chartsInitialized) {
        setTimeout(() => {
            initializeCharts();
            updateCharts();
            chartsInitialized = true;
        }, 100);
    }
};

// Close modals when clicking outside
window.onclick = function(event) {
    const sellModal = document.getElementById('sellPigModal');
    const deleteModal = document.getElementById('deletePigModal');
    const editModal = document.getElementById('editPigModal');
    const historyModal = document.getElementById('historyModal');
    
    if (event.target === sellModal) {
        closeSellModal();
    }
    if (event.target === deleteModal) {
        closeDeleteModal();
    }
    if (event.target === editModal) {
        closeEditModal();
    }
    if (event.target === historyModal) {
        closeHistoryModal();
    }
};

// Add sample notifications on load
setTimeout(() => {
    if (currentUser) {
        addNotification('System Started', 'SwineCare monitoring system is now active', 'info');
    }
}, 2000);

// Periodic health checks
setInterval(() => {
    if (currentUser && Math.random() < 0.1) {
        const alerts = [
            { title: 'Feed Level Low', message: 'Automatic feeder needs refill', type: 'warning' },
            { title: 'Normal Health Check', message: 'All pigs showing normal behavior', type: 'success' },
            { title: 'Cleaning Reminder', message: 'Pen cleaning scheduled for today', type: 'info' }
        ];
        const randomAlert = alerts[Math.floor(Math.random() * alerts.length)];
        addNotification(randomAlert.title, randomAlert.message, randomAlert.type);
    }
}, 30000);

// Mobile Sidebar Toggle
const sidebar = document.getElementById('sidebar');
const mainContent = document.getElementById('mainContent');
const menuBtn = document.querySelector('.mobile-menu-btn');

if (menuBtn) {
    menuBtn.addEventListener('click', () => {
        sidebar.classList.toggle('show');
        mainContent.classList.toggle('full-width');
    });
}

document.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', () => {
        if (window.innerWidth <= 768) {
            sidebar.classList.remove('show');
            mainContent.classList.remove('full-width');
        }
    });
});

document.addEventListener('click', (e) => {
    if (window.innerWidth <= 768 && sidebar.classList.contains('show')) {
        if (!sidebar.contains(e.target) && !menuBtn.contains(e.target)) {
            sidebar.classList.remove('show');
            mainContent.classList.remove('full-width');
        }
    }
});
    </script>
</body>
</html>